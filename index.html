<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konfigurator f√ºr Physik-Simulation</title>
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #F0F8FF;
            --primary-accent: rgba(0,90,156,0.08);
            --marker-color: #e3f2fd;
            --primary-border: rgba(0,90,156,0.20);
            --border-color: #B0C4DE;
            --background-color: #F8F9FA;
            --text-color: #333;
            --input-bg-color: #FFFFFF;
            --button-color: #007BFF;
            --button-hover-color: #0056b3;
            --add-button-color: #28a745;
            --add-button-hover-color: #218838;
            --sticky-footer-height: 96px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            padding-bottom: calc(var(--sticky-footer-height) + 40px);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--input-bg-color);
            padding: 30px;
            padding-bottom: calc(var(--sticky-footer-height) + 40px);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .post-landing {
            max-width: 1100px;
            margin: 0 auto;
            padding-left: 16px;
            padding-right: 16px;
            box-sizing: border-box;
        }

        @media (max-width: 720px) {
            .post-landing { padding-left: 12px; padding-right: 12px; }
        }

        .page {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            padding: 32px;
            position: relative;
            background-image: repeating-linear-gradient(to bottom, rgba(0,90,156,0.04) 0px, rgba(0,90,156,0.04) 1px, transparent 1px, transparent 28px);
            background-size: 100% 28px;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 360ms ease, transform 360ms ease;
        }
        .page.enter {
            opacity: 1;
            transform: none;
        }
        .page::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 12px;
            bottom: 12px;
            width: 10px;
            background: radial-gradient(circle at 50% 10%, rgba(0,90,156,0.12) 2px, transparent 3px);
            background-repeat: repeat-y;
            background-size: 10px 36px;
            opacity: 0.6;
            pointer-events: none;
        }

        #post-landing-wrapper { box-shadow: 0 24px 60px rgba(0,0,0,0.14); }

        h1 { color: var(--primary-color); text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 15px; }
        h2 { color: var(--primary-color); margin-top: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }

        .form-header h1 { color: var(--primary-color); font-size: 2.5em; margin: 10px 0 0 0; border-bottom: 2px solid var(--marker-color); padding-bottom: 12px; }
        .phase-badge { background: var(--marker-color); color: var(--primary-color); padding: 5px 15px; border-radius: 20px; font-weight: bold; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px; display: inline-block; }

        .lang-switcher { position: absolute; top: 15px; right: 20px; font-size: 0.9em; background: #f8f9fa; padding: 5px 10px; border-radius: 20px; border: 1px solid #ddd; }
        .lang-btn { background: none; border: none; cursor: pointer; font-weight: bold; color: #333; }
        .lang-sep { color: #ccc; padding: 0 6px; }

        .info-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #e0e0e0; }
        .role-question { display: block; font-weight: bold; margin-bottom: 10px; color: #555; }
        .role-options { display: flex; justify-content: center; gap: 20px; }
        .role-option { cursor: pointer; display: flex; align-items: center; background: white; padding: 8px 15px; border-radius: 20px; border: 1px solid #ccc; transition: 0.2s; }
        .role-option input[type="radio"] { margin-right: 8px; }

        .template-section { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; width: 100%; }
        .template-intro { font-size: 0.9em; color: #888; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .template-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

        .contact-info { margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; font-size: 0.85em; color: #888; line-height: 1.5; }
        .contact-link { color: var(--primary-color); text-decoration: none; }

        #missing-toggle-btn { display: none; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .muted-small { font-size: 0.8em; color: #666; }
        .small-input { width: 100px; }
        .small-input-120 { width: 120px; }
        .tiny-input { width: 80px; padding: 5px; }
        .medium-input { width: 200px; padding: 5px; }
        #generate-btn { width: auto; margin: 0; padding: 10px 40px; box-shadow: 0 4px 15px rgba(0,123,255,0.3); }
        .checkbox-inline { margin-top: 5px; margin-right: 8px; flex-shrink: 0; }
        .note-label { margin-top: 2px; margin-right: 5px; white-space: nowrap; font-weight: bold; }
        .small-vspace { margin-top: 5px; margin-bottom: 5px; }
        fieldset { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 25px; background-color: #fff; }
        legend { font-weight: bold; font-size: 1.2em; color: var(--primary-color); padding: 0 10px; margin-left: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; }

        input[type="text"], input[type="number"], textarea, select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; box-sizing: border-box;
            font-size: 16px !important;
            background-color: var(--input-bg-color);
        }
        input[type="number"] { -moz-appearance: textfield; }
        textarea { resize: vertical; min-height: 80px; }
        .checkbox-group label, .radio-group label { font-weight: normal; display: flex; align-items: center; margin-bottom: 8px; }
        input[type="checkbox"], input[type="radio"] { margin-right: 10px; flex-shrink: 0; }
        .inline-input { display: inline-block; width: auto; margin-left: 10px; flex-grow: 1; }
       
        .object-section, .interaction-section { border: 1px dashed var(--border-color); padding: 15px; margin-top: 15px; border-radius: 5px; background-color: var(--secondary-color); }
        .add-button { display: inline-block; background-color: var(--add-button-color); color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-top: 10px; transition: background-color 0.3s ease; }
        .add-button:hover { background-color: var(--add-button-hover-color); }
        .delete-btn { background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 10px; margin-left: 15px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .delete-btn:hover { background-color: #c82333; }
        .submit-button { display: block; width: 100%; padding: 15px; background-color: var(--button-color); color: white; border: none; border-radius: 5px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; }
        .submit-button:hover { background-color: var(--button-hover-color); }
        .flex-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .flex-item { flex: 1; min-width: 250px; }

        .collapsible-section { margin-top: 15px; padding-top: 10px; border-top: 1px solid #e0e0e0; }
        .collapsible-section > label { font-size: 1.1em; }
        .options-box { padding: 15px; margin-top: 10px; background-color: var(--secondary-color); border-radius: 5px; border: 1px solid var(--border-color); }
        .options-box.checkbox-group label { width: 48%; display: inline-flex; min-width: 200px; }
       
        #prompt-output-container { display: none; margin-top: 30px; }
        #generated-prompt { width: 100%; height: 350px; padding: 15px; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--secondary-color); font-family: Consolas, "Courier New", monospace; font-size: 0.9em; line-height: 1.5; resize: vertical; }
        #copy-prompt-btn { background-color: var(--add-button-color); margin-top: 15px; }
        #copy-prompt-btn:hover { background-color: var(--add-button-hover-color); }
        #copy-success-msg { color: var(--add-button-color); font-weight: bold; margin-top: 10px; display: none; }
        .hint-text { text-align: center; color: #666; font-size: 0.9em; margin-top: -20px; margin-bottom: 30px; font-style: italic; }
        .required { color: red; font-weight: bold; margin-left: 4px; }

        .accordion { background-color: #e9ecef; color: var(--text-color); cursor: pointer; padding: 12px 15px; width: 100%; text-align: left; border: 1px solid var(--border-color); border-radius: 5px; outline: none; transition: 0.3s; font-weight: 600; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        .accordion:hover, .accordion.active { background-color: #dfe6ed; }
        .accordion:after { content: '\002B'; font-weight: bold; float: right; }
        .accordion.active:after { content: "\2212"; }
        .panel { padding: 0 15px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 5px 5px; margin-bottom: 10px; }
        .panel label { margin-top: 10px; margin-bottom: 10px; display: flex; }
        .sub-panel { margin-left: 25px; padding-left: 10px; border-left: 3px solid var(--border-color); display: none; margin-bottom: 10px; }
        .sub-panel label { font-size: 0.95em; color: #555; }

        .visual-card-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .visual-card { flex: 1; min-width: 140px; border: 2px solid var(--border-color); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; background: white; position: relative; }
        .visual-card input[type="radio"] { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .visual-card:hover { border-color: var(--primary-color); background-color: #f0f8ff; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .visual-card:has(input:checked) { border-color: var(--add-button-color); background-color: #e8f5e9; box-shadow: 0 0 0 2px var(--add-button-color) inset; }
        .card-icon { font-size: 2em; display: block; margin-bottom: 5px; }
        .card-title { font-weight: bold; display: block; font-size: 0.95em; }

        .progress-wrapper { position: sticky; top: 0; z-index: 90; background: var(--background-color); padding-top: 10px; padding-bottom: 10px; margin-bottom: 20px; }
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 10px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary-color), var(--add-button-color)); transition: width 0.5s ease-in-out; }
        .progress-bar.locked { transition: none !important; }
        .progress-wrapper.not-sticky { position: static !important; top: auto !important; z-index: auto !important; box-shadow: none !important; }
        .progress-text { text-align: right; font-size: 0.8em; color: #666; margin-top: 3px; }

        #landing-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); z-index: 9999; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; padding: 20px; box-sizing: border-box; }
        .landing-card { position: relative; background: white; padding: 40px 50px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); max-width: 600px; width: 100%; border-top: 5px solid var(--primary-color); margin: auto; text-align: center; pointer-events: auto; }
        .landing-title { color: var(--primary-color); font-size: 2.5em; margin-bottom: 10px; }
        .landing-subtitle { font-size: 1.2em; color: #666; margin-bottom: 30px; }
        .features-grid { display: inline-grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; text-align: left; margin-left: auto; margin-right: auto; max-width: fit-content; }
        .feature-item { display: flex; align-items: center; font-size: 0.95em; color: #444; }
        .feature-icon { font-size: 1.5em; margin-right: 10px; }
        .start-btn-large { background-color: var(--primary-color); color: white; font-size: 1.3em; padding: 15px 40px; border: none; border-radius: 50px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; font-weight: bold; box-shadow: 0 4px 15px rgba(0, 90, 156, 0.3); }
        .start-btn-large:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 90, 156, 0.4); background-color: var(--button-hover-color); }
        .template-btn { background-color: white; border: 2px solid #e0e0e0; color: #555; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.95em; }
        .template-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background-color: #f0f8ff; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .help-icon { display: inline-block; width: 18px; height: 18px; background-color: #e9ecef; color: var(--primary-color); border-radius: 50%; text-align: center; line-height: 18px; font-size: 12px; font-weight: bold; cursor: help; margin-left: 8px; position: relative; }
        .help-icon:hover::after { content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background-color: #333; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 0.85em; font-weight: normal; white-space: pre-wrap; width: 250px; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .help-icon:hover::before { content: ''; position: absolute; bottom: 110%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }

        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 20px; z-index: 100; border-top: 1px solid #eee; height: var(--sticky-footer-height); }
        .footer-spacer { height: var(--sticky-footer-height); }
        #animation-configurator { padding-bottom: calc(var(--sticky-footer-height) + 40px); }
       
        .missing-list { font-size: 0.85em; color: #d9534f; background-color: #fdf2f2; padding: 8px; border-radius: 5px; margin-top: 5px; display: none; border: 1px solid #f5c6cb; }
        .missing-toggle { background: none; border: none; color: #6c757d; font-size: 0.85em; cursor: pointer; padding: 0; margin-top: 3px; transition: color 0.2s; }
        .missing-toggle:hover { color: var(--primary-color); }

        .input-with-icon { position: relative; display: flex; align-items: center; }
        .coord-hint { position: absolute; right: 10px; font-size: 0.8em; color: #999; pointer-events: none; background-color: rgba(255,255,255,0.8); padding: 0 4px; }
       
        #promptFrame { margin-top: 50px; border: 2px solid var(--border-color); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background-color: white; border: none; }
        .btn-ghost { background-color: #f8f9fa; border: 1px solid #ccc; color: #555; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: all 0.2s; }
        .btn-danger-outline { background-color: #fff; border: 1px solid #dc3545; color: #dc3545; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9em; }

        .next-step-highlight { background-color: #e8f4fd; border: 2px solid var(--primary-color); border-radius: 8px; padding: 20px; margin-top: 20px; margin-bottom: 20px; text-align: center; position: relative; box-shadow: 0 4px 20px rgba(0, 90, 156, 0.2); animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(0, 90, 156, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 90, 156, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 90, 156, 0); } }
        .arrow-down { font-size: 2em; color: var(--primary-color); display: block; margin-top: 10px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

        /* --- LEHRER SPEZIAL-INFO --- */
        .teacher-only { display: none; margin-top: 8px; padding: 10px; background-color: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 6px; font-size: 0.85em; color: #2e7d32; }
        .teacher-diagram { width: 100%; max-width: 200px; height: auto; border: 1px solid #ccc; background: white; margin-top: 5px; display: block; }
    </style>
</head>
<body>

    <div id="landing-overlay">
        <div class="landing-card">
            <div class="lang-switcher">
                <button id="lang-btn-de" onclick="setLanguage('de')" class="lang-btn">DE</button>
                <span class="lang-sep">|</span>
                <button id="lang-btn-en" onclick="setLanguage('en')" class="lang-btn">EN</button>
            </div>

            <h1 class="landing-title" data-i18n="landing_title">Physik-Sim Generator</h1>
            <p class="landing-subtitle">
                <span data-i18n="landing_subtitle">Erstelle interaktive Physik-Simulationen mit KI-Unterst√ºtzung.</span><br>
                <strong data-i18n="landing_sub_code">Ohne eine Zeile Code zu schreiben.</strong>
            </p>
           
            <div class="features-grid">
                <div class="feature-item"><span class="feature-icon">‚öõÔ∏è</span> <span data-i18n="feat_engine">Echte Physik-Engine</span></div>
                <div class="feature-item"><span class="feature-icon">üìà</span> <span data-i18n="feat_plots">Live-Diagramme</span></div>
                <div class="feature-item"><span class="feature-icon">üéÆ</span> <span data-i18n="feat_ctrl">Interaktive Steuerung</span></div>
                <div class="feature-item"><span class="feature-icon">üéì</span> <span data-i18n="feat_didact">Didaktische Szenarien</span></div>
            </div>

            <div class="info-box">
                <label class="role-question" data-i18n="role_question">Wer bist du?</label>
                <div class="role-options">
                    <label class="role-option">
                        <input type="radio" name="user_role" value="student" checked>
                        <span data-i18n="role_student">üéì Sch√ºler:in</span>
                    </label>
                    <label class="role-option">
                        <input type="radio" name="user_role" value="teacher">
                        <span data-i18n="role_teacher">üë®‚Äçüè´ Lehrer:in</span>
                    </label>
                </div>
            </div>

            <button id="start-app-btn" class="start-btn-large" data-i18n="btn_start">Leeres Projekt starten üöÄ</button>

            <div class="template-section">
                <p class="template-intro" data-i18n="template_intro">Oder starte mit einer Vorlage:</p>
                <div class="template-row">
                    <button class="template-btn" data-type="pendulum" data-i18n="temp_pendulum">‚è±Ô∏è Fadenpendel</button>
                    <button class="template-btn" data-type="collision" data-i18n="temp_collision">üé± Elastischer Sto√ü</button>
                    <button class="template-btn" data-type="orbit" data-i18n="temp_orbit">ü™ê Planetenbahn</button>
                    <button class="template-btn" data-type="monkey">üêí Affenschuss</button>
                </div>
            </div>
            <div class="contact-info">
                Projekt im Rahmen einer Zulassungsarbeit am<br>
                <strong>Lehrstuhl f√ºr Didaktik der Physik, LMU M√ºnchen</strong><br><br>
                Entwickelt von: <strong>Yichen Wang</strong><br>
                Feedback? <a href="mailto:Yichen.Wang@campus.lmu.de" class="contact-link">Yichen.Wang@campus.lmu.de</a>
            </div>
        </div>
    </div>
   
    <div class="post-landing page" id="post-landing-wrapper">
        <div class="form-header post-landing" id="main-header">
            <div style="text-align: center; margin-bottom: 10px;"><span class="phase-badge">Phase 1</span></div>
            <h1>Konfigurator f√ºr Physik-Simulation</h1>

            <div class="progress-wrapper">
                <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div class="progress-text" id="progressText">0% der Pflichtfelder (*) ausgef√ºllt</div>
                    <button type="button" id="missing-toggle-btn" class="missing-toggle">‚ùì Was fehlt?</button>
                </div>
                <div id="missing-list-container" class="missing-list"></div>
            </div>

            <p class="hint-text">Hinweis: Felder mit <span class="required">*</span> sind empfehlenswert auszuf√ºllen.</p>

            <div class="toolbar">
                <div style="display: flex; gap: 10px;">
                    <button type="button" id="back-to-menu-btn" class="btn-ghost" onclick="document.getElementById('back-to-menu-btn').click()">‚¨ÖÔ∏è Zum Start-Men√º</button>
                    <button type="button" id="reset-form-btn" class="btn-danger-outline">‚Üª Formular leeren</button>
                </div>
                <div id="save-status" style="font-size: 0.9em; color: var(--add-button-color); font-weight: bold; opacity: 0; transition: opacity 0.5s;">üíæ √Ñnderungen automatisch gespeichert</div>
            </div>
       
            <form id="animation-configurator" class="post-landing">
               
                <input type="hidden" id="hidden_prompt_injection" name="hidden_prompt_injection" value="">
               
                <fieldset>
                    <legend>Teil 1: Grundsetup</legend>
                    <div class="form-group">
                        <label for="anim-title">Titel der Simulation: <span class="required">*</span></label>
                        <input type="text" id="anim-title" name="anim_title" placeholder="z.B. Energieerhaltung beim Fadenpendel">
                    </div>
                    <div class="form-group">
                        <label for="learning-goal">Zentrales Lernziel: <span class="required">*</span></label>
                        <textarea id="learning-goal" name="learning_goal" placeholder="Was ist die Kernaussage, die Sch√ºlerinnen und Sch√ºler verstehen sollen?"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Physikalischer Fokus (Kategorie w√§hlen):</label>
                        <button type="button" class="accordion">Mechanik</button>
                        <div class="panel checkbox-group">
                            <label><input type="checkbox" name="core_principle" value="Energieerhaltungssatz"> Energieerhaltungssatz</label>
                            <label><input type="checkbox" name="core_principle" value="Impulserhaltungssatz"> Impulserhaltungssatz</label>
                            <div class="small-vspace">
                                <label><input type="checkbox" id="newton-toggle" name="core_principle" value="Newtonsche Gesetze"> Newtonsche Gesetze</label>
                                <div id="newton-sub-options" class="sub-panel">
                                    <label><input type="checkbox" name="core_principle" value="1. Newtonsches Gesetz (Tr√§gheitsprinzip)"> 1. Gesetz (Tr√§gheit)</label>
                                    <label><input type="checkbox" name="core_principle" value="2. Newtonsches Gesetz (F=m*a)"> 2. Gesetz (F = m ¬∑ a)</label>
                                    <label><input type="checkbox" name="core_principle" value="3. Newtonsches Gesetz (Actio = Reactio)"> 3. Gesetz (Actio = Reactio)</label>
                                </div>
                            </div>
                            <label><input type="checkbox" name="core_principle" value="Drehimpulserhaltung"> Drehimpulserhaltung</label>
                            <label><input type="checkbox" name="core_principle" value="Hookesches Gesetz"> Hookesches Gesetz</label>
                            <label><input type="checkbox" name="core_principle" value="Gravitationsgesetz"> Gravitationsgesetz</label>
                        </div>
                        <button type="button" class="accordion">Elektromagnetismus</button>
                        <div class="panel checkbox-group">
                            <label><input type="checkbox" name="core_principle" value="Ladungserhaltung"> Ladungserhaltung</label>
                            <label><input type="checkbox" name="core_principle" value="Coulombsches Gesetz"> Coulombsches Gesetz</label>
                            <label><input type="checkbox" name="core_principle" value="Lorentzkraft"> Lorentzkraft</label>
                            <label><input type="checkbox" name="core_principle" value="Ohmsches Gesetz"> Ohmsches Gesetz</label>
                        </div>
                        <button type="button" class="accordion">Schwingungen & Wellen</button>
                        <div class="panel checkbox-group">
                            <label><input type="checkbox" name="core_principle" value="Superpositionsprinzip"> Superpositionsprinzip</label>
                        </div>
                        <div class="checkbox-group" style="margin-top: 10px;">
                             <label><input type="checkbox" name="core_principle" value="other"> Andere: <input type="text" class="inline-input" name="core_principle_other"></label>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Teil 2: Definition des Systems</legend>
                    <div class="form-group">
                        <label style="margin-bottom: 15px;">Gravitation w√§hlen: <span class="required">*</span></label>
                        <div class="visual-card-group">
                            <label class="visual-card"><input type="radio" name="gravity" value="none"><span class="card-icon">üöÄ</span><span class="card-title">Keine</span><span class="muted-small">Schwerelos</span></label>
                            <label class="visual-card"><input type="radio" name="gravity" value="earth"><span class="card-icon">üåç</span><span class="card-title">Erde</span><span class="muted-small">9,81 m/s¬≤</span></label>
                            <label class="visual-card"><input type="radio" name="gravity" value="moon"><span class="card-icon">üåï</span><span class="card-title">Mond</span><span class="muted-small">1,62 m/s¬≤</span></label>
                        </div>
                        <div style="margin-top: 10px;"><label style="font-weight:normal;"><input type="radio" name="gravity" value="custom"> Benutzerdefiniert: <input type="number" class="inline-input small-input" name="gravity_custom" placeholder="m/s¬≤"></label></div>
                    </div>
                    <div class="form-group">
                        <label style="margin-bottom: 15px;">Umgebungsmedium: <span class="required">*</span></label>
                        <div class="visual-card-group">
                            <label class="visual-card"><input type="radio" name="medium" value="vacuum"><span class="card-icon">üåå</span><span class="card-title">Vakuum</span><span class="muted-small">Kein Widerstand</span></label>
                            <label class="visual-card"><input type="radio" name="medium" value="air"><span class="card-icon">üí®</span><span class="card-title">Luft</span><span class="muted-small">Luftwiderstand</span></label>
                            <label class="visual-card"><input type="radio" name="medium" value="water"><span class="card-icon">üíß</span><span class="card-title">Wasser</span><span class="muted-small">Auftrieb + Bremse</span></label>
                        </div>
                        <div style="margin-top: 10px;"><label style="font-weight:normal;"><input type="radio" name="medium" value="other"> Andere: <input type="text" class="inline-input small-input-120" name="medium_custom" placeholder="z.B. √ñl"></label></div>
                    </div>
                    <div class="form-group checkbox-group">
                        <label style="font-size: 1.1em; margin-bottom: 15px;">Globale Felder (optional):</label>
                        <div style="margin-bottom: 20px; border-left: 3px solid #eee; padding-left: 10px;">
                            <div><label style="font-weight: bold; cursor: pointer;"><input type="checkbox" name="e_field"> Homogenes E-Feld</label></div>
                            <div style="margin-left: 28px; margin-top: 5px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 5px;"><span style="font-size: 0.95em;">St√§rke:</span><input type="number" name="e_field_strength" placeholder="N/C" class="tiny-input"></div>
                                <div style="display: flex; align-items: center; gap: 5px;"><span style="font-size: 0.95em;">Richtung:</span>
                                    <select name="e_field_select" id="e_field_select" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                                        <option value="0, 1">‚¨ÜÔ∏è Nach oben</option>
                                        <option value="0, -1">‚¨áÔ∏è Nach unten</option>
                                        <option value="1, 0">‚û°Ô∏è Nach rechts</option>
                                        <option value="-1, 0">‚¨ÖÔ∏è Nach links</option>
                                        <option value="custom">‚úèÔ∏è Benutzerdefiniert</option>
                                    </select>
                                </div>
                            </div>
                            <div id="e_field_custom_container" style="display: none; margin-left: 28px; margin-top: 8px;"><input type="text" id="e_field_custom" name="e_field_custom" placeholder="Vektor z.B. 1, 1" class="medium-input"></div>
                        </div>
                        <div style="margin-bottom: 20px; border-left: 3px solid #eee; padding-left: 10px;">
                            <div><label style="font-weight: bold; cursor: pointer;"><input type="checkbox" name="b_field"> Homogenes B-Feld</label></div>
                            <div style="margin-left: 28px; margin-top: 5px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 5px;"><span style="font-size: 0.95em;">St√§rke:</span><input type="number" name="b_field_strength" placeholder="T" class="tiny-input"></div>
                                <div style="display: flex; align-items: center; gap: 5px;"><span style="font-size: 0.95em;">Richtung:</span>
                                    <select name="b_field_select" id="b_field_select" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                                        <option value="into">‚äó In die Ebene hinein</option>
                                        <option value="out">‚äô Aus der Ebene heraus</option>
                                        <option value="custom">‚úèÔ∏è Benutzerdefiniert</option>
                                    </select>
                                </div>
                            </div>
                            <div id="b_field_custom_container" style="display: none; margin-left: 28px; margin-top: 8px;"><input type="text" id="b_field_custom" name="b_field_custom" placeholder="Vektor z.B. 0, 0, 1" class="medium-input"></div>
                        </div>
                        <div style="margin-top: 10px; border-left: 3px solid #eee; padding-left: 10px;">
                            <div style="display: flex; align-items: flex-start;">
                                <label style="display:inline-flex; align-items: flex-start; width: 100%; cursor: pointer;">
                                    <input type="checkbox" name="global_note_active" class="checkbox-inline"> <span class="note-label">Anmerkung:</span>
                                    <textarea name="global_note_text" class="inline-input auto-expand" placeholder="Zus√§tzliche Parameter..." rows="1"></textarea>
                                </label>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Teil 3: Objekte und ihre Eigenschaften</legend>
                    <div id="objects-container">
                        <div class="object-section">
                            <div style="border-bottom: 2px solid #eee; margin-bottom: 15px; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <h4 style="margin: 0; color: var(--primary-color);">Objekt 1</h4>
                                <label style="font-size: 0.9em; cursor: pointer; color: #d9534f;"><input type="checkbox" name="obj1_fixed" value="yes"> üîí Fixiert (unbeweglich)</label>
                            </div>
                            <div class="flex-container" style="align-items: flex-end;">
                                <div class="flex-item form-group">
                                    <label>Bezeichnung:<span class="required">*</span></label>
                                    <input type="text" name="obj1_name" placeholder="z.B. Flummi">
                                </div>
                                <div class="flex-item form-group">
                                    <label>Form:</label>
                                    <select name="obj1_shape">
                                        <option value="Kreis/Kugel">Kreis / Kugel</option>
                                        <option value="Rechteck/Quader">Rechteck / Quader</option>
                                        <option value="Punktmasse">Punktmasse</option>
                                    </select>
                                </div>
                                <div class="flex-item form-group" style="flex: 0 0 100px;">
                                    <label>Farbe:</label>
                                    <input type="color" name="obj1_color" value="#3498db" style="height: 42px; padding: 2px; cursor: pointer; width: 100%;">
                                </div>
                            </div>
                            <div style="background-color: #eef2f5; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                                <label style="font-weight: bold; margin-bottom: 10px; display: block;">Eigenschaften:</label>
                                <div class="flex-container">
                                    <div class="flex-item form-group" style="margin-bottom: 0;">
                                        <label>Masse (kg):</label><input type="number" name="obj1_mass" placeholder="z.B. 1.0" min="0" step="0.1">
                                    </div>
                                    <div class="flex-item form-group" style="margin-bottom: 0;">
                                        <label>Radius/Breite (m):</label><input type="number" name="obj1_size" placeholder="z.B. 0.5" min="0" step="0.01">
                                    </div>
                                    <div class="flex-item form-group" style="margin-bottom: 0;">
                                        <label>Ladung (C):</label><input type="number" name="obj1_charge" placeholder="z.B. 0">
                                    </div>
                                    <div class="flex-item form-group" style="margin-bottom: 0;">
                                        <label>Elastizit√§t (0-1): <span class="help-icon" data-tooltip="0 = Unelastisch&#10;1 = Elastisch">?</span></label>
                                        <input type="number" name="obj1_bounciness" placeholder="0.8" step="0.1" max="1" min="0">
                                        <div class="teacher-only">
                                            <strong>üë®‚Äçüè´ Fach-Hintergrund:</strong><br>
                                            Hier wird der Restitutionskoeffizient $k$ eingestellt ($v' = k \cdot v$). Im Materialzusammenhang entspricht das dem linear-elastischen Bereich (Hookesches Gesetz):
                                            <svg class="teacher-diagram" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg">
                                                <line x1="20" y1="100" x2="190" y2="100" stroke="black" stroke-width="2" />
                                                <line x1="20" y1="100" x2="20" y2="10" stroke="black" stroke-width="2" />
                                                <text x="180" y="115" font-family="sans-serif" font-size="10">Œµ (Dehnung)</text>
                                                <text x="5" y="15" font-family="sans-serif" font-size="10">œÉ</text>
                                                <line x1="20" y1="100" x2="100" y2="20" stroke="#005A9C" stroke-width="3" />
                                                <text x="105" y="30" font-family="sans-serif" font-size="10" fill="#005A9C">E-Modul</text>
                                                <path d="M 100 20 Q 140 15 180 30" stroke="#999" stroke-width="2" stroke-dasharray="4" fill="none"/>
                                                <text x="120" y="10" font-family="sans-serif" font-size="9" fill="#999">Plastisch</text>
                                            </svg>
                                            <div style="font-size:0.8em; margin-top:2px;">Steigung = Elastizit√§tsmodul $E = \sigma / \epsilon$</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-container">
                                <div class="flex-item form-group">
                                    <label>Startposition (x, y) [m]:</label>
                                    <div class="input-with-icon"><input type="text" name="obj1_pos" placeholder="z.B. 0, 5"><span class="coord-hint">X‚û° Y‚¨Ü</span></div>
                                </div>
                                <div class="flex-item form-group">
                                    <label>Startgeschwindigkeit (v_x, v_y) [m/s]:</label>
                                    <div class="input-with-icon"><input type="text" name="obj1_vel" placeholder="z.B. 10, 0"><span class="coord-hint">X‚û° Y‚¨Ü</span></div>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;"><span style="font-weight: bold; margin-right: 10px;">Anmerkung / Besonderheit:</span></label>
                                <textarea name="obj1_note" class="auto-expand" placeholder="z.B. Soll an einem Seil h√§ngen..." rows="1"></textarea>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-button" id="addObjectBtn">+ Objekt hinzuf√ºgen</button>
                </fieldset>
               
                <fieldset>
                    <legend>Teil 4: Interaktionen & Kr√§fte</legend>
                    <div id="interactions-container">
                        <div class="interaction-section">
                            <div style="border-bottom: 2px solid #eee; margin-bottom: 15px; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                                <h4 style="margin: 0; color: var(--primary-color);">Interaktion 1</h4>
                                <div>
                                    <label style="font-size: 0.9em; cursor: pointer; margin-right: 10px;">
                                        <input type="checkbox" name="interaction1_active"> Aktiv
                                        <span class="help-icon" style="background-color: #adb5bd; color: white;" data-tooltip="Haken setzen: Die Kraft wirkt zwischen den Objekten.">!</span>
                                    </label>
                                    <label style="font-size: 0.9em; cursor: pointer; color: #005A9C;">
                                        <input type="checkbox" name="interaction1_show_vector"> Vektor zeigen
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label>Art der Interaktion:</label>
                                <select name="interaction1_type" class="interaction-type-select">
                                    <option value="none">-- Bitte w√§hlen --</option>
                                    <option value="Kollision">Kollision (Sto√ü)</option>
                                    <option value="Federkraft">Federkraft</option>
                                    <option value="Seilkraft">Seilkraft / Stange</option>
                                    <option value="Gravitation_Newton">Gravitation (Newton)</option>
                                    <option value="Reibungskraft">Reibungskraft</option>
                                    <option value="Coulomb">Coulombkraft</option>
                                    <option value="Lorentz">Lorentzkraft</option>
                                    <option value="custom">üõ†Ô∏è Benutzerdefiniert</option>
                                </select>
                            </div>
                            <div class="custom-interaction-field" style="display: none; background-color: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ffeeba;">
                                <label style="font-weight: bold; color: #856404;">Eigene Formel / Logik:</label>
                                <input type="text" name="interaction1_custom_formula" placeholder="z.B. F = -0.5 * v">
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 15px;">
                                <div style="flex: 1;"><label style="font-size: 0.9em; font-weight: bold; color: #555;">Objekt A:</label><input type="text" name="interaction1_objA" placeholder="z.B. Objekt 1"></div>
                                <div style="padding-bottom: 8px; font-size: 1.5em; color: var(--primary-color);">‚ÜîÔ∏è</div>
                                <div style="flex: 1;"><label style="font-size: 0.9em; font-weight: bold; color: #555;">Objekt B:</label><input type="text" name="interaction1_objB" placeholder="z.B. Objekt 2"></div>
                            </div>
                            <div class="form-group">
                                <label for="interaction1-params">Parameter & Details:</label>
                                <textarea id="interaction1-params" name="interaction1_params" class="auto-expand" placeholder="z.B. Federkonstante D=50..." rows="2" style="font-family: inherit; padding: 8px;"></textarea>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-button" id="addInteractionBtn">+ Interaktion hinzuf√ºgen</button>
                </fieldset>

                <fieldset>
                    <legend>Teil 5: Visualisierung & Analyse</legend>
                    <div class="form-group">
                        <label style="font-weight: bold; margin-bottom: 10px; display: block;">In der Animation anzeigen:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <label><input type="checkbox" name="viz_in_anim" value="Geschwindigkeitspfeile"> Geschwindigkeit (v)</label>
                            <label><input type="checkbox" name="viz_in_anim" value="Beschleunigungspfeile"> Beschleunigung (a)</label>
                            <label><input type="checkbox" name="viz_in_anim" value="Kraftpfeile"> Kraft (F)</label>
                            <label><input type="checkbox" name="viz_in_anim" value="Spur/Trajektorie"> Spur (Trajektorie)</label>
                            <label><input type="checkbox" name="viz_in_anim" value="Koordinatengitter"> Koordinatengitter</label>
                            <label><input type="checkbox" name="viz_in_anim" value="Live-Werte"> Live-Werte</label>
                            <label><input type="checkbox" name="viz_in_anim" value="Stroboskop"> Stroboskop</label>
                            <label><input type="checkbox" name="viz_in_anim" value="Energiebalken"> Energiebalken</label>
                        </div>
                        <div style="margin-top: 10px;"><label style="display: flex; align-items: center;"><input type="checkbox" name="viz_custom_active"> <span style="margin-right: 10px;">Andere:</span><input type="text" name="viz_custom_text" placeholder="z.B. Drehimpulsvektor" style="flex: 1;"></label></div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

                    <div class="collapsible-section">
                        <label style="font-weight: bold; font-size: 1.1em; cursor: pointer;"><input type="checkbox" name="add_diagram" id="addDiagramCheckbox"> üìà Echtzeit-Diagramm hinzuf√ºgen</label>
                        <div class="options-box" id="diagram-options" style="display: none; background-color: #f8f9fa; border-left: 4px solid var(--primary-color);">
                            <div class="form-group">
                                <label>Diagramm-Typ:</label>
                                <select name="diagram_type" style="width: 100%;">
                                    <option value="Liniendiagramm (Zeitverlauf)">Liniendiagramm (Zeitverlauf)</option>
                                    <option value="Balkendiagramm (Energie)">Balkendiagramm (Energien)</option>
                                    <option value="Scatterplot (Phasenraum)">Scatterplot (Phasenraum)</option>
                                </select>
                            </div>
                            <div class="flex-container">
                                <div class="flex-item form-group">
                                    <label>X-Achse:</label>
                                    <select name="diagram_x_axis" id="diag_x_select">
                                        <option value="Zeit (t)">Zeit (t)</option>
                                        <option value="Position (x)">Position (x)</option>
                                        <option value="Position (y)">Position (y)</option>
                                        <option value="Winkel (phi)">Winkel (œÜ)</option>
                                        <option value="custom">‚úèÔ∏è Benutzerdefiniert...</option>
                                    </select>
                                    <input type="text" name="diagram_x_custom" id="diag_x_custom" placeholder="Formel/Gr√∂√üe" style="display:none; margin-top:5px;">
                                </div>
                                <div class="flex-item form-group">
                                    <label>Y-Achse:</label>
                                    <select name="diagram_y_axis" id="diag_y_select">
                                        <option value="Position (y)">Position (y)</option>
                                        <option value="Geschwindigkeit (v)">Geschwindigkeit (v)</option>
                                        <option value="Beschleunigung (a)">Beschleunigung (a)</option>
                                        <option value="Energie (kin/pot)">Energie (kin + pot)</option>
                                        <option value="Impuls (p)">Impuls (p)</option>
                                        <option value="custom">‚úèÔ∏è Benutzerdefiniert...</option>
                                    </select>
                                    <input type="text" name="diagram_y_custom" id="diag_y_custom" placeholder="Formel/Gr√∂√üe" style="display:none; margin-top:5px;">
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc;">
                                <label style="font-size: 0.95em; color: var(--primary-color); margin-bottom: 8px;">Feste Skalierung (Optional, aber empfohlen):</label>
                                <div class="flex-container">
                                    <div class="flex-item">
                                        <label style="font-weight: normal; font-size: 0.9em;">X-Achse (von - bis):</label>
                                        <div style="display: flex; gap: 5px;"><input type="number" name="diag_x_min" placeholder="Min" style="width: 50%;"><input type="number" name="diag_x_max" placeholder="Max" style="width: 50%;"></div>
                                    </div>
                                    <div class="flex-item">
                                        <label style="font-weight: normal; font-size: 0.9em;">Y-Achse (von - bis):</label>
                                        <div style="display: flex; gap: 5px;"><input type="number" name="diag_y_min" placeholder="Min" style="width: 50%;"><input type="number" name="diag_y_max" placeholder="Max" style="width: 50%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="collapsible-section">
                        <label style="font-weight: bold; font-size: 1.1em; cursor: pointer;"><input type="checkbox" name="add_table" id="addTableCheckbox"> üìã Datenerfassung</label>
                        <div class="options-box" id="table-options" style="display: none; background-color: #fff3cd; border-left: 4px solid #ffc107;">
                            <div class="form-group checkbox-group">
                                <label style="font-weight: 600;">Daten:</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                                    <label><input type="checkbox" name="table_cols" value="Zeit (t)"> Zeit (t)</label>
                                    <label><input type="checkbox" name="table_cols" value="Position (x/y)"> Position (x,y)</label>
                                    <label><input type="checkbox" name="table_cols" value="Geschwindigkeit (v)"> Geschwindigkeit</label>
                                    <label><input type="checkbox" name="table_cols" value="Beschleunigung (a)"> Beschleunigung</label>
                                    <label><input type="checkbox" name="table_cols" value="Energien (E_kin, E_pot)"> Energien</label>
                                </div>
                            </div>
                            <div class="flex-container" style="margin-top: 15px;">
                                <div class="flex-item form-group">
                                    <label>Messrate:</label>
                                    <select name="table_frequency">
                                        <option value="Jeden Frame (Max Details)">Jeden Frame</option>
                                        <option value="Alle 0.1 Sekunden" selected>Alle 0.1 Sekunden</option>
                                        <option value="Alle 0.5 Sekunden">Alle 0.5 Sekunden</option>
                                    </select>
                                </div>
                                <div class="flex-item form-group">
                                    <label>Export:</label><label style="font-weight: normal;"><input type="checkbox" name="table_export_csv" checked> Button "Download als CSV" anzeigen</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Teil 6: Steuerung & Didaktik</legend>
                    <div class="form-group checkbox-group">
                        <label style="font-weight: bold; margin-bottom: 10px; display: block;">Welche Buttons sollen verf√ºgbar sein?<span class="required">*</span></label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <label><input type="checkbox" name="controls" value="Start / Pause"> Start / Pause</label>
                            <label><input type="checkbox" name="controls" value="Reset (Neu starten)"> Reset</label>
                            <label><input type="checkbox" name="controls" value="Einzelschritt (Frame-by-Frame)"> Frame-by-Frame ‚è≠Ô∏è</label>
                            <label><input type="checkbox" name="controls" value="Zeitlupe (Slow Motion)"> Zeitlupe üêå</label>
                            <label><input type="checkbox" name="controls" value="Parameter-Reset"> Nur Parameter zur√ºcksetzen ‚Ü©Ô∏è</label>
                            <label><input type="checkbox" name="controls" value="Vollbild"> Vollbild-Modus ‚õ∂</label>
                        </div>
                    </div>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                    <div class="collapsible-section">
                        <label style="font-weight: bold; font-size: 1.1em; color: var(--primary-color);">Vordefinierte Szenarien (Presets)</label>
                        <p style="font-size: 0.9em; color: #666; margin-top: 5px;">Erstellt Buttons, die bestimmte Werte sofort laden.</p>
                        <div id="scenarios-container"></div>
                        <button type="button" class="add-button" id="addScenarioBtn" style="background-color: #17a2b8; font-size: 0.9em;">+ Szenario-Button hinzuf√ºgen</button>
                    </div>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                    <div class="form-group">
                        <label style="font-weight: bold;">Didaktische Methode:</label>
                        <select id="didactic_method_select" name="didactic_method" style="margin-bottom: 15px;">
                            <option value="none">-- Keine (nur Simulation) --</option>
                            <option value="info">Einfache Infobox (Erkl√§rungstext)</option>
                            <option value="tasks">Aufgabenliste (Checkliste)</option>
                            <option value="prediction">Vorhersage-Modus (Quiz vor Start)</option>
                        </select>
                        <div id="method_info_field" style="display: none;">
                            <label>Erkl√§rungstext:</label><textarea name="didactic_info_text" class="auto-expand" rows="2" placeholder="Beschreibe hier den Versuchsaufbau..."></textarea>
                        </div>
                        <div id="method_tasks_field" style="display: none;">
                            <label>Aufgaben (eine pro Zeile):</label><textarea name="didactic_tasks_list" class="auto-expand" rows="3" placeholder="1. Starte die Simulation..."></textarea>
                        </div>
                        <div id="method_prediction_field" style="display: none; background-color: #e3f2fd; padding: 15px; border-radius: 5px; border: 1px solid #90caf9;">
                            <label style="color: #0d47a1;">Frage an den Sch√ºler (vor dem Start):</label><input type="text" name="didactic_prediction_question" placeholder="Was passiert bei Kollision?">
                            <label style="color: #0d47a1;">Antwortm√∂glichkeiten (kommagetrennt):</label><input type="text" name="didactic_prediction_options" placeholder="Abprallen, Kleben bleiben...">
                            <label style="font-size: 0.9em; margin-top: 5px; color: #555;"><input type="checkbox" name="didactic_prediction_block"> Simulation sperren, bis geantwortet wurde?</label>
                        </div>
                    </div>
                </fieldset>

                <fieldset id="hypothesis-section" style="background-color: #fff8e1; border-color: #ffe082;">
                    <legend style="color: #f57f17;">ü§î Deine Vermutung <span class="required">*</span></legend>
                    <div class="form-group">
                        <label for="student-hypothesis">Bevor du die Simulation startest: <p style="font-size: 0.9em; margin-bottom: 10px; color: #666;">Beschreibe kurz, was du erwartest.</p>
                        <textarea id="student-hypothesis" name="student_hypothesis" class="auto-expand" rows="2" placeholder="Ich vermute, dass..." style="border: 1px solid #ffe082;"></textarea>
                    </div>
                </fieldset>

                <div style="margin-top: 40px; margin-bottom: 40px; text-align: center; border-top: 2px dashed #ccc; padding-top: 20px;">
                    <h3 style="color: #28a745;">üèÅ Formular abgeschlossen!</h3>
                    <p style="color: #666; max-width: 600px; margin: 0 auto;">Du hast das Ende erreicht. √úberpr√ºfe kurz deine Eingaben oben.</p>
                    <p style="font-size: 0.9em; color: #999; margin-top: 10px;">Danach auf "Simulation erstellen" klicken.</p>
                </div>

                <div class="footer-spacer"></div>
                <div class="sticky-footer" style="flex-direction: column; align-items: center; gap: 5px;">
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <button type="button" class="add-button" style="background-color: #6c757d; margin: 0;" onclick="document.getElementById('back-to-menu-btn').click()">Men√º</button>
                        <button type="submit" class="submit-button" id="generate-btn">üöÄ Simulation erstellen</button>
                    </div>
                    <div style="font-size: 0.85em; color: #555;">Klicke hier erst, wenn du mind. alle Felder mit <span style="color:red">*</span> ausgef√ºllt hast.</div>
                </div>
            </form>
        </div>
       
        <div id="workspace-area" class="post-landing" style="display: none; margin-top: 60px; border-top: 4px dashed #e0e0e0; padding-top: 40px;">
            <div style="text-align: center; margin-bottom: 40px;">
                <span style="background: #e3f2fd; color: var(--primary-color); padding: 5px 15px; border-radius: 20px; font-weight: bold; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px;">Phase 2</span>
                <h2 style="color: var(--primary-color); font-size: 2.5em; margin: 10px 0 0 0;">üß™ Simulation Workspace</h2>
                <p style="color: #666; font-size: 1.1em;">Hier entsteht deine Simulation. Chatte mit der KI, um sie zu verfeinern.</p>
            </div>

            <div id="prompt-output-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0; color: #555;">Generierter Prompt:</h3>
                    <button type="button" id="scroll-up-btn" style="background: white; border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; color: var(--primary-color); font-size: 0.9em;">‚úèÔ∏è Eingaben korrigieren</button>
                </div>
                <details id="prompt-details">
                    <summary style="cursor: pointer; font-weight: bold; padding: 10px; background: #f0f0f0; border-radius: 5px;">Generierten Prompt anzeigen / verbergen</summary>
                    <textarea id="generated-prompt" readonly placeholder="Hier erscheint der generierte Prompt..."></textarea>
                </details>
                <div id="copy-success-msg" style="display:none; color: green; margin-top: 10px; font-weight: bold;">‚úÖ Automatisch an das Chat-Fenster unten gesendet!</div>
                <div class="next-step-highlight">
                    <div style="font-weight: bold; font-size: 1.2em; color: var(--primary-color); margin-bottom: 5px;">Fast geschafft!</div>
                    <div style="font-size: 1em; color: #333;">Der Prompt wurde erfolgreich generiert. <br>M√∂chtest du noch etwas √§ndern? Dann klicke rechts oben auf 'Eingaben korrigieren'.<br>Wenn alles bereit ist, klicke jetzt unten im Chat-Fenster auf:<br>
                    <span style="background-color: var(--primary-color); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; display: inline-block; margin: 10px 0;">‚û§ Anfrage senden</span>
                    </div>
                    <div class="arrow-down">‚¨áÔ∏è</div>
                </div>
            </div>
           
            <iframe id="promptFrame" src="api.html" height="1800" width="100%" style="border: none;"></iframe>
           
            <div style="margin-top: 60px; margin-bottom: 20px; padding: 30px; background-color: #f1f8e9; border: 2px solid #81c784; border-radius: 12px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05);">
                <h3 style="margin-top: 0; color: #2e7d32; font-size: 1.5em;">üíæ Experiment beendet?</h3>
                <p style="color: #555; font-size: 1em; margin-bottom: 15px;"><strong>Schritt 1:</strong> Kopiere den Chatverlauf im Fenster oben (Klick auf "üìã Chat kopieren").<br><strong>Schritt 2:</strong> F√ºge ihn hier unten ein:</p>
                <textarea id="chat-history-input" style="width: 90%; height: 150px; padding: 10px; border: 1px solid #81c784; border-radius: 5px; font-family: inherit; font-size: 0.9em; margin-bottom: 20px;" placeholder="Rechtsklick 'Einf√ºgen' oder lange dr√ºcken auf dem iPad..."></textarea><br>
                <button type="button" id="download-protocol-btn" style="background-color: #2e7d32; color: white; border: none; padding: 15px 35px; border-radius: 50px; font-size: 1.2em; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3); transition: transform 0.2s;">üì• Vollst√§ndiges Protokoll herunterladen</button>
            </div>
           
            <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #999; font-size: 0.85em; line-height: 1.6;">
                &copy; 2026 Physik-Sim Konfigurator<br>
                Zulassungsarbeit am <strong>Lehrstuhl f√ºr Didaktik der Physik, LMU M√ºnchen</strong><br>
                Entwickelt von <strong>Yichen Wang</strong> | <a href="mailto:Yichen.Wang@campus.lmu.de" style="color: #777;">Yichen.Wang@campus.lmu.de</a>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        try {
        // --- 1. SETUP & DEFINITIONEN (Ganz oben!) ---
        const TEMPLATES = {
            pendulum: {
                counts: { obj: 2, int: 1, scen: 0 },
                formValues: {
                    "anim_title": "Fadenpendel Simulation",
                    "learning_goal": "Untersuchung der Energieerhaltung und Periodendauer.",
                    "gravity": "earth",
                    "core_principle": ["Energieerhaltungssatz"],
                    "obj1_name": "Aufh√§ngung", "obj1_fixed": "yes", "obj1_pos": "0, 10",
                    "obj2_name": "Pendel", "obj2_shape": "Kreis/Kugel", "obj2_mass": "2", "obj2_pos": "5, 5",
                    "interaction1_type": "Seilkraft", "interaction1_objA": "Aufh√§ngung", "interaction1_objB": "Pendel",
                    "interaction1_active": "on", "interaction1_show_vector": "on",
                    "add_diagram": "on", "diagram_type": "Liniendiagramm (Zeitverlauf)", "diagram_x_axis": "Zeit (t)", "diagram_y_axis": "Energie (kin/pot)",
                    "controls": ["Start / Pause", "Reset (Neu starten)"]
                }
            },
            collision: {
                counts: { obj: 2, int: 1, scen: 2 },
                formValues: {
                    "anim_title": "Elastischer Sto√ü",
                    "learning_goal": "Impulserhaltung verstehen.",
                    "gravity": "none", "medium": "vacuum",
                    "core_principle": ["Impulserhaltungssatz"],
                    "obj1_name": "Links", "obj1_pos": "-5, 0", "obj1_vel": "4, 0", "obj1_bounciness": "1",
                    "obj2_name": "Rechts", "obj2_pos": "5, 0", "obj2_vel": "-4, 0", "obj2_bounciness": "1",
                    "interaction1_type": "Kollision", "interaction1_objA": "Links", "interaction1_objB": "Rechts", "interaction1_active": "on",
                    "controls": ["Start / Pause", "Reset (Neu starten)"],
                    "scenario_label_1": "Gleich", "scenario_desc_1": "M1=M2",
                    "scenario_label_2": "Schwer", "scenario_desc_2": "M2=10"
                }
            },
            orbit: {
                counts: { obj: 2, int: 1, scen: 0 },
                formValues: {
                    "anim_title": "Planetenbahn",
                    "gravity": "none",
                    "core_principle": ["Gravitationsgesetz"],
                    "obj1_name": "Sonne", "obj1_mass": "1000", "obj1_fixed": "yes", "obj1_pos": "0, 0",
                    "obj2_name": "Erde", "obj2_mass": "10", "obj2_pos": "10, 0", "obj2_vel": "0, 8",
                    "interaction1_type": "Gravitation_Newton", "interaction1_objA": "Sonne", "interaction1_objB": "Erde", "interaction1_active": "on",
                    "viz_in_anim": ["Spur/Trajektorie"], "controls": ["Start / Pause"]
                }
            },
            monkey: {
                counts: { obj: 2, int: 0, scen: 0 },
                formValues: {
                    "anim_title": "Affenschuss (Superpositionsprinzip)",
                    "learning_goal": "Verstehen, dass die waagerechte und senkrechte Bewegung unabh√§ngig sind. Beide Objekte fallen gleich schnell.",
                    // --- VERSCH√ÑRFTE GEHEIME LERNZIELE ---
                    "hidden_prompt_injection": "DEINE ZENTRALEN LERNZIELE F√úR DEN SCH√úLER SIND:\n1. Erkl√§ren, warum der Affe trotz Loslassens getroffen wird (Unabh√§ngigkeit der Bewegungen).\n2. Die Bewegung beim schr√§gen Wurf analysieren.\n3. Die Situation mathematisch modellieren.\nDIDAKTISCHE REGELN F√úR DEN CHAT (ZUS√ÑTZLICH ZUM CODE):\n1. Verrate die L√∂sung NIEMALS sofort! Keine direkten Antworten.\n2. In deiner ERSTEN Nachricht: Begr√º√üe den Sch√ºler freundlich als 'Tutor Newton', gib ihm den HTML-Code, und frage GANZ AM ENDE explizit: 'Bitte starte jetzt die Simulation und schau, was passiert! Hat die Kugel getroffen? Schreib mir deine Beobachtung hier in den Chat!'\n3. Wenn der Sch√ºler antwortet, f√ºhre SOKRATISCHE DIALOGE.\nBAU-HINWEIS: Zeichne zwingend Trajektorien ein und f√ºge eine gestrichelte horizontale Linie zwischen Kugel und Affe ein, um zu zeigen, dass sie stets auf derselben y-H√∂he sind.",
                    "gravity": "earth", "medium": "vacuum",
                    "core_principle": ["Superpositionsprinzip", "Newtonsche Gesetze"],
                    "obj1_name": "Projektil", "obj1_shape": "Kreis/Kugel", "obj1_mass": "0.1", "obj1_size": "0.2", "obj1_pos": "0, 0", "obj1_vel": "15, 8", "obj1_color": "#e74c3c",
                    "obj2_name": "Affe", "obj2_shape": "Kreis/Kugel", "obj2_mass": "5", "obj2_size": "0.5", "obj2_pos": "15, 8", "obj2_vel": "0, 0", "obj2_color": "#8e44ad", "obj1_note": "Zielt exakt auf den Affen.", "obj2_note": "L√§sst im exakt gleichen Moment los, in dem das Projektil abgefeuert wird.",
                    "viz_in_anim": ["Spur/Trajektorie", "Geschwindigkeitspfeile"],
                    "controls": ["Start / Pause", "Reset (Neu starten)", "Zeitlupe (Slow Motion)"]
                }
            }
        };

        const translations = {
            de: {
                "landing_title": "Physik-Sim Generator",
                "landing_subtitle": "Erstelle interaktive Physik-Simulationen mit KI-Unterst√ºtzung.",
                "landing_sub_code": "Ohne eine Zeile Code zu schreiben.",
                "feat_engine": "Echte Physik-Engine",
                "feat_plots": "Live-Diagramme",
                "feat_ctrl": "Interaktive Steuerung",
                "feat_didact": "Didaktische Szenarien",
                "role_question": "Wer bist du?",
                "role_student": "üéì Sch√ºler:in",
                "role_teacher": "üë®‚Äçüè´ Lehrer:in",
                "btn_start": "Leeres Projekt starten üöÄ",
                "template_intro": "Oder starte mit einer Vorlage:",
                "temp_pendulum": "‚è±Ô∏è Fadenpendel",
                "temp_collision": "üé± Elastischer Sto√ü",
                "temp_orbit": "ü™ê Planetenbahn"
            },
            en: {
                "landing_title": "Physics Sim Generator",
                "landing_subtitle": "Create interactive physics simulations powered by AI.",
                "landing_sub_code": "Without writing a single line of code.",
                "feat_engine": "Real Physics Engine",
                "feat_plots": "Live Diagrams",
                "feat_ctrl": "Interactive Controls",
                "feat_didact": "Didactic Scenarios",
                "role_question": "Who are you?",
                "role_student": "üéì Student",
                "role_teacher": "üë®‚Äçüè´ Teacher",
                "btn_start": "Start Empty Project üöÄ",
                "template_intro": "Or start with a template:",
                "temp_pendulum": "‚è±Ô∏è Pendulum",
                "temp_collision": "üé± Elastic Collision",
                "temp_orbit": "ü™ê Planetary Orbit"
            }
        };

        window.setLanguage = function(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });
            document.getElementById('lang-btn-de').style.fontWeight = lang === 'de' ? 'bold' : 'normal';
            document.getElementById('lang-btn-en').style.fontWeight = lang === 'en' ? 'bold' : 'normal';
        };

        document.body.style.overflow = 'hidden';
        const form = document.getElementById('animation-configurator');
        const outputContainer = document.getElementById('prompt-output-container');
        const promptTextarea = document.getElementById('generated-prompt');
        const detailsElement = document.getElementById('prompt-details');
        const copyMsg = document.getElementById('copy-success-msg');
        const iframe = document.getElementById("promptFrame");

        const addObjectBtn = document.getElementById('addObjectBtn');
        const addInteractionBtn = document.getElementById('addInteractionBtn');
        const addScenarioBtn = document.getElementById('addScenarioBtn');
        const resetFormBtn = document.getElementById('reset-form-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const startAppBtn = document.getElementById('start-app-btn');
        const copyBtn = document.getElementById('copy-prompt-btn');
        const scrollUpBtn = document.getElementById('scroll-up-btn');

        const objectsContainer = document.getElementById('objects-container');
        const interactionsContainer = document.getElementById('interactions-container');
        const scenariosContainer = document.getElementById('scenarios-container');
        const landingOverlay = document.getElementById('landing-overlay');
        const saveStatus = document.getElementById('save-status');
        const workspaceArea = document.getElementById('workspace-area');

        const storageKey = 'physics_config_v1';
        let objectCounter = 1;
        let interactionCounter = 1;
        let progressLocked = false;
        let submitted = false;

        function updateProgressBar() {
            let missing = [];
            const title = document.getElementById('anim-title');
            if (!title || title.value.trim().length === 0) missing.push("Titel der Simulation");
            const goal = document.getElementById('learning-goal');
            if (!goal || goal.value.trim().length === 0) missing.push("Lernziel");
            if (!document.querySelector('input[name="gravity"]:checked')) missing.push("Gravitation (Teil 2)");
            if (!document.querySelector('input[name="medium"]:checked')) missing.push("Umgebungsmedium (Teil 2)");
            const obj1Name = document.querySelector('input[name="obj1_name"]');
            if (!obj1Name || obj1Name.value.trim().length === 0) missing.push("Name von Objekt 1");
            if (document.querySelectorAll('input[name="controls"]:checked').length === 0) missing.push("Steuerungs-Buttons (Teil 6)");

            const role = localStorage.getItem('physics_user_role') || 'student';
            if (role === 'student') {
                const hypo = document.getElementById('student-hypothesis');
                if (!hypo || hypo.value.trim().length < 3) missing.push("Deine Vermutung (Hypothese)");
            }

            let totalRequired = (role === 'student') ? 7 : 6;
            let filledCount = totalRequired - missing.length;
            let percentage = Math.round((filledCount / totalRequired) * 100);
            if (percentage < 0) percentage = 0; if (percentage > 100) percentage = 100;

            const bar = document.getElementById('progressBar');
            const text = document.getElementById('progressText');
            const missingToggleBtn = document.getElementById('missing-toggle-btn');
            const missingListContainer = document.getElementById('missing-list-container');

            if (bar && text) {
                if (missing.length === 0) {
                    text.textContent = "üéâ 100 % der Pflichtfelder erf√ºllt! Jetzt kannst du ‚ÄûSimulation erstellen‚Äú anklicken. Mehr Angaben = besseres Ergebnis & weniger Anpassungen üöÄ";
                    text.style.color = '#28a745';
                    text.style.fontWeight = 'bold';
                    if (missingToggleBtn) missingToggleBtn.style.display = 'none';
                    if (missingListContainer) missingListContainer.style.display = 'none';
                } else {
                    text.textContent = `${percentage}% der Pflichtfelder (*) ausgef√ºllt`;
                    text.style.color = '#666';
                    text.style.fontWeight = 'normal';
                    if (missingToggleBtn) missingToggleBtn.style.display = 'block';
                    if (missingListContainer) missingListContainer.innerHTML = "<strong>Noch offen:</strong> " + missing.join(", ");
                }

                bar.style.width = percentage + '%';
                if (missing.length === 0) bar.style.backgroundColor = '#28a745';
                else if (percentage < 30) bar.style.backgroundColor = '#dc3545';
                else if (percentage < 70) bar.style.backgroundColor = '#ffc107';
                else bar.style.backgroundColor = '#17a2b8';

                const wrapper = document.querySelector('.progress-wrapper');
                const submitBtn = document.getElementById('generate-btn');
               
                if (percentage === 100) {
                    progressLocked = true;
                    bar.classList.add('locked');
                    if(submitBtn) { submitBtn.disabled = false; submitBtn.style.opacity = "1"; }
                } else {
                    if (progressLocked) {
                        progressLocked = false;
                        bar.classList.remove('locked');
                    }
                    if(submitBtn) { submitBtn.disabled = true; submitBtn.style.opacity = "0.5"; }
                }
                if (wrapper) {
                    if (progressLocked && submitted) wrapper.classList.add('not-sticky');
                    else wrapper.classList.remove('not-sticky');
                }
            }
        }

        const missingToggleBtn = document.getElementById('missing-toggle-btn');
        const missingListContainer = document.getElementById('missing-list-container');
        if (missingToggleBtn) {
            missingToggleBtn.addEventListener('click', () => {
                if (missingListContainer.style.display === 'none') {
                    missingListContainer.style.display = 'block';
                    missingToggleBtn.textContent = "‚ùå Schlie√üen";
                } else {
                    missingListContainer.style.display = 'none';
                    missingToggleBtn.textContent = "‚ùì Was fehlt?";
                }
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        const saveDebounced = debounce(() => saveToStorage(), 500);

        form.addEventListener('input', () => { updateProgressBar(); saveDebounced(); });
        form.addEventListener('change', () => { updateProgressBar(); saveToStorage(); });
        window.addEventListener('load', () => { progressLocked = false; submitted = false; const wrapper = document.querySelector('.progress-wrapper'); if (wrapper) wrapper.style.display = 'block'; updateProgressBar(); });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const header = document.getElementById('main-header');
            if(header) header.style.position = 'static';
            if(workspaceArea) workspaceArea.style.display = 'block';

            const prompt = buildPrompt(form);
            promptTextarea.value = prompt;
            outputContainer.style.display = 'block';
            if(detailsElement) detailsElement.open = false;
            promptTextarea.style.height = 'auto';
            promptTextarea.style.height = (promptTextarea.scrollHeight + 5) + 'px';

            navigator.clipboard.writeText(prompt).then(() => {
                if(copyMsg) {
                    copyMsg.style.display = 'block';
                    copyMsg.innerText = "‚úÖ Prompt wurde automatisch kopiert! Dr√ºcke unten nur noch Einf√ºgen.";
                }
            }).catch(err => { console.error('Auto-copy failed', err); });

            if (iframe && iframe.contentWindow) {
                const hiddenText = new FormData(form).get('hidden_prompt_injection') || "";
                iframe.contentWindow.postMessage({
                    visiblePrompt: prompt,
                    secretSystemInstruction: hiddenText
                }, '*');
               
                copyMsg.style.display = "block";
                setTimeout(() => { copyMsg.style.display = "none"; }, 4000);
            }

            if (workspaceArea) {
                setTimeout(() => {
                    const yOffset = -20;
                    const y = workspaceArea.getBoundingClientRect().top + window.pageYOffset + yOffset;
                    window.scrollTo({top: y, behavior: 'smooth'});
                }, 50);
            }
        });

        if(copyBtn) {
            copyBtn.addEventListener('click', () => {
                promptTextarea.select();
                document.execCommand('copy');
                copyMsg.textContent = "Kopiert!";
                copyMsg.style.display = 'block';
                setTimeout(() => { copyMsg.style.display = 'none'; }, 2000);
            });
        }
        if (scrollUpBtn) {
            scrollUpBtn.addEventListener('click', () => {
                document.getElementById('animation-configurator').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }

        function addDeleteButton(section) {
            const header = section.querySelector('div');
            if(header.querySelector('.delete-btn')) return;
            const btn = document.createElement('button');
            btn.type = 'button'; btn.className = 'delete-btn';
            btn.innerHTML = 'üóëÔ∏è Entfernen';
            btn.addEventListener('click', () => { section.remove(); updateProgressBar(); saveToStorage(); });
            header.appendChild(btn);
        }

        addObjectBtn.addEventListener('click', () => {
            objectCounter++;
            const newSection = document.createElement('div');
            newSection.className = 'object-section';
            newSection.innerHTML = objectsContainer.querySelector('.object-section').innerHTML;
            newSection.querySelector('h4').textContent = `Zus√§tzliches Objekt`;
            newSection.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.name) el.name = el.name.replace(/obj\d+/, `obj${objectCounter}`);
                if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
                else if (el.type === 'color') el.value = '#3498db';
                else if (el.tagName === 'SELECT') el.selectedIndex = 0;
                else { el.value = ''; if (el.tagName === 'TEXTAREA') el.style.height = 'auto'; }
            });
            addDeleteButton(newSection);
            const area = newSection.querySelector('.auto-expand');
            if(area) setupAutoExpand(area);
            objectsContainer.appendChild(newSection);
            updateProgressBar();
            applyRoleVisibility();
        });

        addInteractionBtn.addEventListener('click', () => {
            interactionCounter++;
            const newSection = document.createElement('div');
            newSection.className = 'interaction-section';
            newSection.innerHTML = interactionsContainer.querySelector('.interaction-section').innerHTML;
            newSection.querySelector('h4').textContent = `Zus√§tzliche Interaktion`;
            newSection.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.name) el.name = el.name.replace(/interaction\d+/, `interaction${interactionCounter}`);
                if (el.type === 'checkbox') el.checked = false;
                else if (el.tagName === 'SELECT') el.selectedIndex = 0;
                else el.value = '';
            });
           
            const customDiv = newSection.querySelector('.custom-interaction-field');
            if(customDiv) customDiv.style.display = 'none';
            const typeSelect = newSection.querySelector('.interaction-type-select');
            if(typeSelect && customDiv) {
                typeSelect.addEventListener('change', function() {
                    customDiv.style.display = (this.value === 'custom') ? 'block' : 'none';
                });
            }
            addDeleteButton(newSection);
            interactionsContainer.appendChild(newSection);
            updateProgressBar();
        });

        function setupAutoExpand(el) {
            el.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }
        document.querySelectorAll('.auto-expand').forEach(setupAutoExpand);

        const acc = document.getElementsByClassName("accordion");
        for (let i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                if (panel.style.maxHeight) panel.style.maxHeight = null;
                else panel.style.maxHeight = panel.scrollHeight + "px";
            });
        }

        function setupToggle(triggerId, targetId, displayType='block') {
            const trigger = document.getElementById(triggerId);
            const target = document.getElementById(targetId);
            if(trigger && target && trigger.type === 'checkbox') {
                trigger.addEventListener('change', () => {
                    target.style.display = trigger.checked ? displayType : 'none';
                    const parent = trigger.closest('.panel');
                    if(parent && parent.style.maxHeight) parent.style.maxHeight = parent.scrollHeight + "px";
                });
            }
        }
        setupToggle('newton-toggle', 'newton-sub-options');
        setupToggle('addDiagramCheckbox', 'diagram-options');
        setupToggle('addTableCheckbox', 'table-options');

        function setupSelectToggle(selId, contId, val='custom') {
            const sel = document.getElementById(selId);
            const cont = document.getElementById(contId);
            if(sel && cont) {
                sel.addEventListener('change', () => {
                    cont.style.display = (sel.value === val) ? 'block' : 'none';
                });
            }
        }
        setupSelectToggle('e_field_select', 'e_field_custom_container');
        setupSelectToggle('b_field_select', 'b_field_custom_container');
        setupSelectToggle('diag_x_select', 'diag_x_custom');
        setupSelectToggle('diag_y_select', 'diag_y_custom');
       
        const initIntSel = document.querySelector('.interaction-type-select');
        const initIntCust = document.querySelector('.custom-interaction-field');
        if(initIntSel && initIntCust) {
            initIntSel.addEventListener('change', () => {
                initIntCust.style.display = (initIntSel.value === 'custom') ? 'block' : 'none';
            });
        }

        const methodSelect = document.getElementById('didactic_method_select');
        const mInfo = document.getElementById('method_info_field');
        const mTasks = document.getElementById('method_tasks_field');
        const mPred = document.getElementById('method_prediction_field');
        if (methodSelect) {
            methodSelect.addEventListener('change', function() {
                mInfo.style.display = 'none'; mTasks.style.display = 'none'; mPred.style.display = 'none';
                if (this.value === 'info') mInfo.style.display = 'block';
                if (this.value === 'tasks') mTasks.style.display = 'block';
                if (this.value === 'prediction') mPred.style.display = 'block';
            });
        }

        if (addScenarioBtn) {
            addScenarioBtn.addEventListener('click', () => {
                const div = document.createElement('div');
                div.className = 'scenario-card';
                div.style.cssText = "border: 1px solid #d1d1d1; background-color: #f9f9f9; border-radius: 6px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);";
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; margin-bottom: 10px;">
                        <strong class="scenario-title" style="color: var(--primary-color);">Szenario-Button X</strong>
                        <button type="button" class="delete-btn" style="margin: 0;">üóëÔ∏è Entfernen</button>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 0.9em; color: #555; margin-bottom: 4px;">Button-Beschriftung:</label>
                        <input type="text" name="scenario_label_TEMP" placeholder="z.B. 'Fall A'" style="width: 100%">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.9em; color: #555; margin-bottom: 4px;">Funktion:</label>
                        <input type="text" name="scenario_desc_TEMP" placeholder="z.B. Masse=5" style="width: 100%;">
                    </div>
                `;
                div.querySelector('.delete-btn').addEventListener('click', function() {
                    div.remove();
                    updateScenarioNumbering();
                    saveToStorage();
                });
                scenariosContainer.appendChild(div);
                updateScenarioNumbering();
                saveToStorage();
            });
        }

        function updateScenarioNumbering() {
            const allScenarios = scenariosContainer.querySelectorAll('.scenario-card');
            allScenarios.forEach((div, index) => {
                const newNum = index + 1;
                div.querySelector('.scenario-title').textContent = `Szenario-Button ${newNum}`;
                div.querySelector('input[name^="scenario_label_"]').name = `scenario_label_${newNum}`;
                div.querySelector('input[name^="scenario_desc_"]').name = `scenario_desc_${newNum}`;
            });
        }

        function saveToStorage() {
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (data[key]) { if (!Array.isArray(data[key])) data[key] = [data[key]]; data[key].push(value); }
                else { data[key] = value; }
            }
            const state = {
                formValues: data,
                counts: { obj: objectCounter, int: interactionCounter, scen: document.querySelectorAll('.scenario-card').length }
            };
            localStorage.setItem(storageKey, JSON.stringify(state));
            if(saveStatus) { saveStatus.style.opacity = '1'; setTimeout(() => { saveStatus.style.opacity = '0'; }, 2000); }
        }

        function restoreState(state) {
            while (objectCounter < state.counts.obj) addObjectBtn.click();
            while (interactionCounter < state.counts.int) addInteractionBtn.click();
            let currentScenarios = document.querySelectorAll('.scenario-card').length;
            while (currentScenarios < state.counts.scen) { if(addScenarioBtn) addScenarioBtn.click(); currentScenarios++; }

            setTimeout(() => {
                for (const [key, value] of Object.entries(state.formValues)) {
                    const inputs = form.querySelectorAll(`[name="${key}"]`);
                    if (inputs.length > 0) {
                        if (inputs[0].type === 'radio') { inputs.forEach(radio => { if (radio.value === value) radio.checked = true; }); }
                        else if (inputs[0].type === 'checkbox') {
                            const valArray = Array.isArray(value) ? value : [value];
                            inputs.forEach(cb => { cb.checked = valArray.includes(cb.value); });
                        }
                        else {
                            inputs[0].value = value;
                            if (key.includes('_select') && value === 'custom') inputs[0].dispatchEvent(new Event('change'));
                            if (inputs[0].tagName === 'TEXTAREA' && inputs[0].classList.contains('auto-expand')) {
                                inputs[0].style.height = 'auto'; inputs[0].style.height = inputs[0].scrollHeight + 'px';
                            }
                        }
                    }
                }
                updateProgressBar();
            }, 50);
        }

        function loadFromStorage() {
            const savedRaw = localStorage.getItem(storageKey);
            if (!savedRaw) { updateProgressBar(); return; }
            try { restoreState(JSON.parse(savedRaw)); } catch (e) { console.error(e); }
        }

        document.querySelectorAll('.template-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const type = btn.getAttribute('data-type');
                saveRoleSelection();
                if(confirm("Vorlage laden?")) {
                    localStorage.removeItem(storageKey);
                    localStorage.setItem('pending_template', JSON.stringify(TEMPLATES[type]));
                    location.reload();
                }
            });
        });

        if (startAppBtn) {
            startAppBtn.addEventListener('click', () => {
                saveRoleSelection();
                document.body.style.overflow = 'auto';
                landingOverlay.style.opacity = '0';
                landingOverlay.style.transform = 'scale(1.1)';
               
                const wrapper = document.getElementById('post-landing-wrapper');
                setTimeout(() => {
                    landingOverlay.style.display = 'none';
                    if (wrapper) wrapper.classList.add('enter');
                }, 500);

                const hasData = localStorage.getItem(storageKey);
                if (hasData) {
                    if(confirm("Mit LEEREM Formular starten?")) {
                        localStorage.removeItem(storageKey);
                        form.reset();
                        document.querySelectorAll('.object-section').forEach((el, idx) => { if(idx > 0) el.remove(); });
                        document.querySelectorAll('.interaction-section').forEach((el, idx) => { if(idx > 0) el.remove(); });
                        document.getElementById('scenarios-container').innerHTML = '';
                        objectCounter = 1; interactionCounter = 1;
                        saveToStorage();
                        updateProgressBar();
                    }
                }
                applyRoleVisibility();
            });
        }

        if (backToMenuBtn) {
            backToMenuBtn.addEventListener('click', () => {
                document.body.style.overflow = 'hidden';
                landingOverlay.style.display = 'flex';
                const wrapper = document.getElementById('post-landing-wrapper');
                if (wrapper) wrapper.classList.remove('enter');
                setTimeout(() => { landingOverlay.style.opacity = '1'; landingOverlay.style.transform = 'scale(1)'; }, 10);
            });
        }

        if (resetFormBtn) {
            resetFormBtn.addEventListener('click', () => {
                if (confirm("Alles l√∂schen?")) { localStorage.removeItem(storageKey); location.reload(); }
            });
        }

        function saveRoleSelection() {
            const role = document.querySelector('input[name="user_role"]:checked').value;
            localStorage.setItem('physics_user_role', role);
        }

        function applyRoleVisibility() {
            const role = localStorage.getItem('physics_user_role') || 'student';
            const hypoSection = document.getElementById('hypothesis-section');
            if (hypoSection) {
                hypoSection.style.display = (role === 'teacher') ? 'none' : 'block';
            }
            const teacherElements = document.querySelectorAll('.teacher-only');
            teacherElements.forEach(el => {
                el.style.display = (role === 'teacher') ? 'block' : 'none';
            });
        }

        const pendingTemplate = localStorage.getItem('pending_template');
        if(pendingTemplate) {
            document.body.style.overflow = 'auto';
            if(landingOverlay) landingOverlay.style.display = 'none';
            const wrapper = document.getElementById('post-landing-wrapper');
            if (wrapper) wrapper.classList.add('enter');
            restoreState(JSON.parse(pendingTemplate));
            localStorage.removeItem('pending_template');
            applyRoleVisibility();
            setTimeout(saveToStorage, 600);
        } else {
            document.body.style.overflow = 'hidden';
            loadFromStorage();
            const savedRole = localStorage.getItem('physics_user_role');
            if(savedRole) {
                const radio = document.querySelector(`input[name="user_role"][value="${savedRole}"]`);
                if(radio) radio.checked = true;
            }
        }

        function buildPrompt(form) {
            const data = new FormData(form);
            let p = [];
            const role = localStorage.getItem('physics_user_role') || 'student';

            p.push("### TECHNISCHE KONFIGURATION ###");
            p.push("Bitte erstelle basierend auf diesen Daten die HTML-Simulation.");

            if (role === 'student') {
                p.push("Zielgruppe: Sch√ºler der 10. Klasse.");
            } else {
                p.push("Zielgruppe: Physiklehrkr√§fte.");
            }

            const title = data.get('anim_title') || 'Physik-Sim';
            const safeTitle = title.replace(/[^a-zA-Z0-9]/g, '') || 'Animation';
            p.push(`Der Titel der Seite lautet: "${title}"`);
            p.push(`Die Datei muss folgendes enthalten: <!DOCTYPE html>, <html>, <head>, <style>, <body> mit <canvas> und UI-Controls, <script> mit der kompletten Logik.`);
            p.push(`WICHTIG: Nutze KEINE externen CSS oder JS Dateien (au√üer CDN f√ºr Chart.js falls ben√∂tigt). Alles muss in einer Datei sein (Single File).`);
           
            p.push("\n### 1. DIDAKTISCHER RAHMEN ###");
            p.push(`Zentrales Lernziel: "${data.get('learning_goal')}". Bitte stelle sicher, dass die Visualisierung dieses Ziel unterst√ºtzt.`);
           
            const principles = getCheckedValues('core_principle', 'core_principle_other');
            if (principles.length > 0) {
                p.push(`Die Simulation MUSS folgende physikalische Prinzipien korrekt implementieren: ${principles.join(', ')}.`);
            }
           
            if (data.get('student_hypothesis')) {
                p.push(`\nSCH√úLER-HYPOTHESE: "${data.get('student_hypothesis')}"`);
                p.push(`Bitte erstelle die Simulation so, dass der Sch√ºler √ºberpr√ºfen kann, ob diese Vermutung stimmt (z.B. durch passende Graphen oder Anzeigen).`);
            }

            p.push("\n### 2. PHYSIKALISCHES SYSTEM ###");
            const gravity = data.get('gravity');
            let gravText = "Keine (0 m/s¬≤)";
            if(gravity === 'earth') gravText = "Erdbeschleunigung (g = 9.81 m/s¬≤)";
            else if(gravity === 'moon') gravText = "Mondbeschleunigung (g = 1.62 m/s¬≤)";
            else if(gravity === 'custom') gravText = `Benutzerdefiniert: ${data.get('gravity_custom')} m/s¬≤`;
            p.push(`- Gravitation: ${gravText} (wirkt global auf alle massereichen Objekte, sofern nicht anders angegeben).`);
           
            const medium = data.get('medium');
            let medText = "Vakuum (keine Reibung)";
            if(medium === 'air') medText = "Luft (Linearer oder quadratischer Luftwiderstand)";
            else if(medium === 'water') medText = "Wasser (Starker Widerstand + Auftrieb)";
            else if(medium === 'other') medText = `Spezialmedium: ${data.get('medium_custom')}`;
            p.push(`- Umgebungsmedium: ${medText}.`);

            if (data.get('e_field')) {
                let d = data.get('e_field_select') === 'custom' ? data.get('e_field_custom') : data.get('e_field_select');
                p.push(`- Globales Elektrisches Feld (E-Feld): St√§rke ${data.get('e_field_strength')} N/C, Richtung Vektor [${d}].`);
                p.push("  -> Hinweis: Wirkt F = q*E auf geladene Teilchen.");
            }
            if (data.get('b_field')) {
                let dVal = data.get('b_field_select');
                let dDesc = dVal;
                if(dVal === 'into') dDesc = "Senkrecht in die Ebene (z-Achse negativ)";
                else if(dVal === 'out') dDesc = "Senkrecht aus der Ebene (z-Achse positiv)";
                else dDesc = `Vektor ${data.get('b_field_custom')}`;
                p.push(`- Globales Magnetfeld (B-Feld): St√§rke ${data.get('b_field_strength')} T, Richtung: ${dDesc}.`);
                p.push("  -> Hinweis: Wirkt Lorentzkraft F = q * (v x B).");
            }
            if (data.get('global_note_active')) {
                p.push(`- ZUS√ÑTZLICHE SYSTEM-BEDINGUNG: ${data.get('global_note_text')}`);
            }

            p.push("\n### 3. OBJEKTE (AKTEURE) ###");
            p.push("Erstelle Klassen oder Objekte f√ºr folgende Elemente:");
            document.querySelectorAll('.object-section').forEach((sect, idx) => {
                const i = idx + 1;
                const name = sect.querySelector(`input[name*="_name"]`).value || `Objekt ${i}`;
                const shape = sect.querySelector(`select[name*="_shape"]`).value;
                const color = sect.querySelector(`input[name*="_color"]`).value;
                const fixed = sect.querySelector(`input[name*="_fixed"]`).checked;
               
                const mass = sect.querySelector(`input[name*="_mass"]`).value;
                const size = sect.querySelector(`input[name*="_size"]`).value;
                const charge = sect.querySelector(`input[name*="_charge"]`).value;
                const bounce = sect.querySelector(`input[name*="_bounciness"]`).value;
               
                const pos = sect.querySelector(`input[name*="_pos"]`).value;
                const vel = sect.querySelector(`input[name*="_vel"]`).value;
                const note = sect.querySelector(`textarea[name*="_note"]`).value;
               
                p.push(`\n**Objekt ${i}: ${name}**`);
                p.push(`  - Visuell: Form=${shape}, Farbe=${color}, Radius/Gr√∂√üe=${size || 'Standard'}.`);
                p.push(`  - Physik: Masse=${mass || 1} kg, Ladung=${charge || 0} C, Elastizit√§t=${bounce || 0.8}.`);
                p.push(`  - Kinematik Start: Pos=[${pos || '0,0'}], Geschw=[${vel || '0,0'}].`);
                p.push(`  - Status: ${fixed ? 'FIXIERT (Bewegt sich nicht durch Kr√§fte)' : 'BEWEGLICH (Dynamisch)'}.`);
                if(note) p.push(`  - BESONDERHEIT/LOGIK: ${note}`);
            });

            p.push("\n### 4. INTERAKTIONEN & KR√ÑFTE ###");
            p.push("Implementiere folgende Wechselwirkungen in jedem Simulationsschritt:");
            const interactionSections = document.querySelectorAll('.interaction-section');
            if (interactionSections.length === 0) p.push("(Keine spezifischen Interaktionen definiert, nur Standard-Physik).");
           
            interactionSections.forEach((section, index) => {
                const type = section.querySelector('select').value;
                if (type !== 'none') {
                    const a = section.querySelector(`input[name*="_objA"]`).value;
                    const b = section.querySelector(`input[name*="_objB"]`).value;
                    const isActive = section.querySelector(`input[name*="_active"]`).checked;
                    const showVec = section.querySelector(`input[name*="_show_vector"]`).checked;
                    const params = section.querySelector('textarea').value;
                   
                    p.push(`- Interaktion ${index+1}: Typ '${type}' zwischen "${a}" und "${b}".`);
                    p.push(`  - Initial-Status: ${isActive ? 'Aktiv' : 'Pausiert'}.`);
                    p.push(`  - Visualisierung: ${showVec ? 'Zeichne Kraftvektor' : 'Kein Vektor'}.`);
                    if(params) p.push(`  - Parameter: ${params}`);
                   
                    if(type === 'custom') {
                        const formula = section.querySelector(`input[name*="_custom_formula"]`).value;
                        p.push(`  - WICHTIG - EIGENE FORMEL: Implementiere exakt diese Logik: "${formula}".`);
                    }
                }
            });

            p.push("\n### 5. VISUALISIERUNG & UI ###");
            const viz = getCheckedValues('viz_in_anim');
            if (data.get('viz_custom_active')) viz.push(data.get('viz_custom_text'));
            if(viz.length) { p.push(`Zeichne folgende Overlays in jedem Frame: ${viz.join(', ')}.`); }
           
            if(data.get('add_diagram')) {
                const type = data.get('diagram_type');
                let dx = data.get('diagram_x_axis'); if(dx==='custom') dx = data.get('diagram_x_custom');
                let dy = data.get('diagram_y_axis'); if(dy==='custom') dy = data.get('diagram_y_custom');
                const xMin = data.get('diag_x_min'); const xMax = data.get('diag_x_max');
                const yMin = data.get('diag_y_min'); const yMax = data.get('diag_y_max');

                p.push(`\n**Feature: Echtzeit-Diagramm**`);
                p.push(`  - Typ: ${type}.`);
                p.push(`  - X-Achse: ${dx}`);
                p.push(`  - Y-Achse: ${dy}`);
                if (xMin && xMax) p.push(`  - WICHTIG: Die X-Achse muss FEST skaliert sein von ${xMin} bis ${xMax}. Kein mitlaufendes Fenster!`);
                else p.push(`  - X-Achse: Auto-Scaling.`);
                if (yMin && yMax) p.push(`  - WICHTIG: Die Y-Achse muss FEST skaliert sein von ${yMin} bis ${yMax}.`);
                else p.push(`  - Y-Achse: Auto-Scaling.`);
                p.push(`  - Das Diagramm soll den Verlauf innerhalb dieser Grenzen zeigen.`);
            }
           
            if(data.get('add_table')) {
                const cols = getCheckedValues('table_cols');
                p.push(`\n**Feature: Data Logger (Tabelle)**`);
                p.push(`  - Spalten: ${cols.join(', ')}`);
                p.push(`  - Update-Rate: ${data.get('table_frequency')}`);
                if(data.get('table_export_csv')) p.push(`  - F√ºge einen Button 'CSV Export' hinzu, um die Daten herunterzuladen.`);
            }

            const controls = getCheckedValues('controls');
            p.push(`\n**Steuerungselemente:**`);
            p.push(`Implementiere Buttons f√ºr: ${controls.join(', ')}.`);
           
            const scenarioLabels = [];
            document.querySelectorAll('input[name^="scenario_label_"]').forEach(input => {
                const id = input.name.split('_')[2];
                const desc = form.querySelector(`input[name="scenario_desc_${id}"]`).value;
                if (input.value) scenarioLabels.push(`Button "${input.value}" -> Setzt: ${desc}`);
            });
            if (scenarioLabels.length) {
                p.push(`\n**Szenarien (Presets):** Erstelle Buttons, die Parameter sofort √§ndern:`);
                scenarioLabels.forEach(s => p.push(`  - ${s}`));
            }

            const method = data.get('didactic_method');
            if(method !== 'none') {
                p.push(`\n**Didaktische Methode:** ${method}`);
                if(method==='info') p.push(`  - Zeige eine Infobox mit: "${data.get('didactic_info_text')}"`);
                if(method==='tasks') p.push(`  - Zeige Checkliste mit Aufgaben: "${data.get('didactic_tasks_list')}"`);
                if(method==='prediction') {
                    p.push(`  - POE-Modus: Blockiere den Start.`);
                    p.push(`  - Zeige Frage: "${data.get('didactic_prediction_question')}"`);
                    p.push(`  - Optionen: ${data.get('didactic_prediction_options')}`);
                    if(data.get('didactic_prediction_block')) p.push("  - Erst nach Antwort darf gestartet werden.");
                }
            }

            p.push("\n### 6. TECHNISCHE IMPLEMENTIERUNG (SEHR WICHTIG) ###");
            p.push("1. **Code-Qualit√§t:** Schreibe sauberen, modernen ES6 JavaScript Code. Nutze Klassen f√ºr Objekte (z.B. class PhysicsObject).");
            p.push("2. **Physik-Engine & Delta-Time:** Verwende eine stabile numerische Integration (z.B. Velocity Verlet oder Semi-Implicit Euler). Arbeite zwingend mit Delta-Time (dt). WICHTIG: Begrenze dt (z.B. `dt = Math.min(dt, 0.05)`), damit die Simulation nach Tab-Wechseln nicht explodiert!");
            p.push("3. **Einheiten, Ma√üstab & Koordinatensystem (CRITICAL):** Die Physik-Logik rechnet in SI-Einheiten (Meter, kg, Sekunden). Der Canvas zeichnet in Pixeln. Definiere zwingend einen Umrechnungsfaktor (z.B. `const SCALE = 50; // 1m = 50px`). Denke daran, dass im Canvas die Y-Achse nach UNTEN zeigt. Transformiere die Zeichen-Koordinaten entsprechend, damit Objekte korrekt nach unten fallen!");
            p.push("4. **Kollisionen & Grenzen:** Implementiere eine robuste Kollisionsaufl√∂sung. Wende bei St√∂√üen 'Positional Correction' (Separation) an, damit Objekte nicht ineinander stecken bleiben. Die Canvas-R√§nder sollen als harte W√§nde dienen, an denen Objekte abprallen (au√üer bei Planetenbahnen).");
            p.push("5. **Single File:** Der gesamte Code (HTML, CSS, JS) muss in EINER einzigen Datei sein. Keine externen CSS/JS Files (au√üer CDN Bibliotheken f√ºr Plots wie Chart.js).");
            p.push("6. **Styling & UI-Layout:** Das Design soll modern und hell sein. Lege UI-Elemente (Buttons, Diagramm-Container, Info-Boxen) als schwebende Overlays (mit `position: absolute` und hohem `z-index`) √ºber den Canvas oder nutze ein sauberes CSS-Grid, bei dem der Canvas nicht von der UI zerdr√ºckt wird.");
            p.push("7. **Layout-Stabilisierung (CRITICAL):** Setze im CSS zwingend: `body, html { margin: 0; padding: 0; overflow: hidden; width: 100%; height: 100%; }`. Der Canvas-Hintergrund muss exakt `window.innerWidth` und `window.innerHeight` f√ºllen. Verhindere Scrollbalken!");
            p.push("8. **Vollst√§ndigkeit:** Der Code muss robust sein. Setze sinnvolle Defaults f√ºr leere Felder. Implementiere ALLE oben genannten Anforderungen vollst√§ndig.");
            return p.join('\n');
        }

        function getCheckedValues(name, otherName = null) {
            const values = [];
            form.querySelectorAll(`input[name="${name}"]:checked`).forEach(cb => {
                if (cb.value === 'other' && otherName) {
                    const val = form.querySelector(`input[name="${otherName}"]`).value;
                    if (val) values.push(val);
                } else {
                    values.push(cb.value);
                }
            });
            return values;
        }

        const downloadBtn = document.getElementById('download-protocol-btn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', () => {
                try {
                    const now = new Date();
                    const timestamp = now.toLocaleString('de-DE');
                    const filenameDate = now.toISOString().slice(0,10) + '_' + now.getHours() + '-' + now.getMinutes();
                   
                    const formData = new FormData(form);
                    let tableRows = '';
                   
                    for (let [key, value] of formData.entries()) {
                        if(value.trim() === '' || key.includes('_TEMP') || key === 'hidden_prompt_injection') continue;
                       
                        let labelText = key;
                        const input = form.querySelector(`[name="${key}"]`);
                        if(input) {
                            let label = input.closest('label');
                            if(!label && input.id) label = document.querySelector(`label[for="${input.id}"]`);
                            if(label) labelText = label.innerText.replace(/[\n\r]+|[*]|Anmerkung:|Aktiv|Vektor zeigen/g, '').trim();
                            if(input.type === 'radio' && label) {
                                const cardTitle = label.querySelector('.card-title');
                                if(cardTitle) labelText = "System: " + cardTitle.innerText;
                            }
                        }
                        tableRows += `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 10px; font-weight: bold; color: #444; width: 40%;">${labelText}</td><td style="padding: 10px; color: #000;">${value}</td></tr>`;
                    }

                    const escapeHTML = (str) => str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const rawPrompt = document.getElementById('generated-prompt').value || "Kein Prompt.";
                    const promptText = escapeHTML(rawPrompt);
                    const chatField = document.getElementById('chat-history-input');
                    const rawChat = chatField && chatField.value.trim() !== "" ? chatField.value : "Kein Chat-Verlauf eingef√ºgt.";
                    const chatText = escapeHTML(rawChat);

                    const reportContent = `
                    <!DOCTYPE html>
                    <html lang="de">
                    <head>
                        <meta charset="UTF-8">
                        <title>Protokoll: ${formData.get('anim_title') || 'Physik-Sim'}</title>
                        <style>
                            body { font-family: 'Segoe UI', sans-serif; line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 40px; background: #fff; }
                            h1 { color: #005A9C; border-bottom: 3px solid #005A9C; padding-bottom: 15px; margin-bottom: 30px; }
                            h2 { margin-top: 50px; background: #e3f2fd; padding: 12px 20px; border-radius: 8px; color: #005A9C; font-size: 1.4em; }
                            table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; }
                            td { vertical-align: top; }
                            .content-box { background: #f8f9fa; padding: 20px; border: 1px solid #ccc; border-radius: 5px; font-family: monospace; white-space: pre-wrap; font-size: 0.9em; }
                            .chat-box { background: #fff3e0; border-color: #ffe0b2; font-family: sans-serif; }
                            .meta { background: #eee; padding: 15px; border-radius: 8px; margin-bottom: 40px; }
                            .footer { margin-top: 80px; font-size: 0.8em; text-align: center; color: #999; border-top: 1px solid #eee; padding-top: 20px; }
                        </style>
                    </head>
                    <body>
                        <h1>üß™ Experiment-Protokoll</h1>
                        <div class="meta">
                            <strong>Datum:</strong> ${timestamp}<br>
                            <strong>Rolle:</strong> ${localStorage.getItem('physics_user_role') === 'teacher' ? 'Lehrer:in' : 'Sch√ºler:in'}
                        </div>
                        <h2>1. Chat-Verlauf (Eingef√ºgt)</h2>
                        <div class="content-box chat-box">${chatText}</div>
                        <h2>2. Konfiguration</h2>
                        <table>${tableRows}</table>
                        <h2>3. Generierter Prompt</h2>
                        <div class="content-box">${promptText}</div>
                        <div class="footer">Erstellt mit dem Physik-Sim Konfigurator der LMU M√ºnchen</div>
                    </body>
                    </html>`;

                    const blob = new Blob([reportContent], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Protokoll_${filenameDate}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    alert("Fehler: " + err.message);
                    console.error(err);
                }
            });
        }

        } catch (e) {
            console.error('Initialization error', e);
            alert('Fehler im Skript: ' + (e && e.message ? e.message : e));
        }
    });
</script>
</body>
</html>
