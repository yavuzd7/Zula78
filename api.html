<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Gemini REST ‚Äì Chat-Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <style>
    /* --- DARK THEME VARIABLEN --- */
    :root {
      --bg: #0b0f14;
      --panel: #121821;
      --panel-light: #18202b;
      --muted: #93a0b4;
      --text: #e7eefc;
      --accent: #78a6ff;
      --danger: #ff6b6b;
      --ok: #67e8a6;
      --warn: #ffc107;
      --border: #1d2531;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --radius: 14px;
    }
    
    html, body {
      background: radial-gradient(1200px 700px at 20% -10%, #142033 0%, var(--bg) 60%);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, sans-serif;
      margin: 0; padding: 0; line-height: 1.4;
    }

    .container { max-width: 980px; margin: 48px auto; padding: 0 16px; }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 8px 40px rgba(0,0,0,0.35);
      padding: 20px;
    }

    h1 { font-size: 24px; margin: 0 0 8px; }
    p.sub { margin: 0 0 24px; color: var(--muted); }

    /* HINWEIS BOX (Empfang) */
    #reception-alert {
        display: none; 
        background: rgba(120, 166, 255, 0.15);
        border: 1px solid var(--accent);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 20px;
        color: var(--accent);
        font-weight: bold;
        animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* GRID & INPUTS */
    .grid { display: grid; gap: 14px; }
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    
    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px; }
    
    input[type="password"], input[type="text"], select, textarea {
      width: 100%; background: var(--panel); color: var(--text);
      border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px;
      outline: none; font-size: 14px; box-sizing: border-box; transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); }
    textarea { min-height: 110px; resize: vertical; }

    .checkbox { display: inline-flex; align-items: center; gap: 10px; color: var(--muted); font-size: 13px; margin-top: 5px; }
    
    .actions { display: flex; gap: 12px; margin-top: 6px; flex-wrap: wrap; }
    
    button {
      background: linear-gradient(180deg, #1b283d, #182133);
      border: 1px solid var(--border); color: var(--text);
      padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 600;
      position: relative;
    }
    button.primary { border-color: rgba(120,166,255,0.5); background: linear-gradient(180deg, #2a3f64, #243552); }
    /* Der Debug Button (Orange/Warnung) */
    button.warning { border-color: rgba(255, 193, 7, 0.5); background: linear-gradient(180deg, #3d351b, #332b18); color: var(--warn); }
    
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* LOADING SPINNER */
    .spinner {
      display: none; position: absolute; left: 50%; top: 50%;
      margin-left: -8px; margin-top: -8px; width: 16px; height: 16px;
      border: 2px solid var(--muted); border-left-color: var(--text);
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    button.loading .spinner { display: block; }
    button.loading .btn-text { opacity: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* OUTPUTS */
    .status { margin-top: 8px; font-size: 13px; color: var(--muted); text-align: right; }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--danger); }
    
    .out { margin-top: 18px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; overflow: auto; max-height: 400px; }
    .title { color: var(--muted); font-size: 12px; text-transform: uppercase; margin-bottom: 8px; }

    .chat-turn { padding: 14px; border-radius: 10px; margin-bottom: 12px; background: var(--panel-light); border: 1px solid transparent; }
    .chat-turn.role-user { border-color: var(--accent); }
    .chat-role { font-size: 11px; font-weight: bold; text-transform: uppercase; color: var(--muted); margin-bottom: 5px; }
    .role-user .chat-role { color: var(--accent); }
    
    pre { background: var(--bg); padding: 10px; border-radius: 8px; overflow-x: auto; font-family: var(--mono); }
    code { font-family: var(--mono); background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px; }

    /* ANIMATION CONTAINER */
    #animation-container {
        display: none; margin-top: 20px; 
        border: 2px solid var(--accent); border-radius: 12px; 
        overflow: hidden; background: white; position: relative;
    }
    .anim-header {
        background: #121821; color: #93a0b4; padding: 8px 15px; 
        font-size: 12px; border-bottom: 1px solid #1d2531;
        display: flex; justify-content: space-between; align-items: center;
    }
    .fullscreen-btn {
        background: transparent; border: 1px solid var(--muted); color: var(--muted);
        padding: 2px 8px; font-size: 10px; border-radius: 4px; margin: 0;
    }
    
    /* Ladebildschirm beim Plotten */
    .anim-loading-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(18, 24, 33, 0.95);
        display: none; 
        justify-content: center; align-items: center; flex-direction: column;
        color: var(--accent); font-weight: bold; font-size: 1.2em;
        z-index: 99;
    }

    /* NEU: DEBUGGING TOOLBOX */
    .debug-box {
        background: var(--panel);
        border-top: 1px solid var(--border);
        padding: 15px;
    }
    .debug-label {
        font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; 
        color: var(--warn); font-weight: bold; margin-bottom: 8px; display: block;
    }
    .debug-input-group {
        display: flex; gap: 10px;
    }
    
    @media (max-width: 700px) { 
        .row-2 { grid-template-columns: 1fr; } 
        .debug-input-group { flex-direction: column; }
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="card">
      <h1>Gemini API ‚Äì Chat-Demo</h1>

      <div id="reception-alert">
          ‚¨áÔ∏è <strong>Prompt empfangen!</strong> Bitte unten √ºberpr√ºfen und auf "Anfrage senden" klicken.
      </div>

      <div class="grid">

        <div id="chat-hint" style="display: none; background: rgba(120, 166, 255, 0.1); border: 1px solid var(--accent); padding: 12px; border-radius: 8px; margin-bottom: 5px; color: var(--text); font-size: 13px;">
            üí° <strong>Tipp:</strong> Probier die Simulation jetzt unten aus! Scrolle danach wieder hier hoch und <strong>antworte Tutor Newton</strong> auf seine Frage im Chat.
        </div>

        <div class="row">
          <div>
            <label for="prompt">Deine Nachricht (Prompt)</label>
            <textarea id="prompt" placeholder="Warte auf Eingabe vom Konfigurator..."></textarea>
          </div>
        </div>

        <div class="actions">
          <button id="send" class="primary">
            <span class="btn-text">‚û§ Anfrage senden</span>
            <span class="spinner"></span>
          </button>
          
          <button id="copyChat" style="border-color: var(--ok); color: var(--ok);">üìã Chat kopieren</button>
          
          <button id="clear">Chat-Verlauf l√∂schen</button>
        </div>
        
        <div id="status" class="status">Bereit.</div>

        <div class="out">
          <div class="title">Chat-Verlauf</div>
          <div id="textOut" class="rendered-text">(noch nichts)</div>
        </div>
      </div>
    </div>

    <div id="animation-container">
      
      <div id="anim-loader" class="anim-loading-overlay">
          <div class="spinner" style="display:block; position:relative; width:30px; height:30px; margin-bottom:15px; top:auto; left:auto;"></div>
          <div>Visualisierung wird geplottet...</div>
      </div>

      <div class="anim-header">
         <span>üöÄ Live-Vorschau</span>
         <button class="fullscreen-btn" onclick="toggleFullScreen()">‚õ∂ Vollbild</button>
      </div>
      
      <iframe id="animation-output" allow="scripts" style="width: 100%; height: 500px; border: none;"></iframe>

      <div class="debug-box">
          <label class="debug-label">üõ†Ô∏è Simulation Debuggen / Verbessern</label>
          <div class="debug-input-group">
              <input type="text" id="debug-input" placeholder="Was stimmt nicht? (z.B. 'Die Kugel f√§llt zu langsam' oder 'Formel ist falsch')" />
              <button id="debug-send" class="warning" style="white-space: nowrap;">
                  <span class="btn-text">Code korrigieren</span>
                  <span class="spinner"></span>
              </button>
          </div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 5px;">
              Klicke auf "Code korrigieren", um Fehler an die KI zu melden. Der Code wird basierend auf deinem Feedback neu generiert.
          </div>
      </div>

    </div>

  </div>

<script>
    // --- 1. KOMMUNIKATION MIT KONFIGURATOR ---
    
    // HIER legen wir die Variable ganz am Anfang an, damit sie √ºberall bekannt ist!
    let currentSecretInstruction = ""; 

    window.addEventListener("message", function(event) {
        const data = event.data;
        
        // Pr√ºfen, ob das neue Daten-Objekt (mit den geheimen Infos) ankommt
        if (data && typeof data === 'object' && data.visiblePrompt) {
            var targetField = document.getElementById("prompt");
            var alertBox = document.getElementById("reception-alert");
            
            if (targetField) {
                targetField.value = data.visiblePrompt; // Nur der saubere Prompt ist sichtbar
                targetField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // HIER speichern wir die geheime Anweisung (Affenschuss-Lernziele) im Hintergrund
            currentSecretInstruction = data.secretSystemInstruction || "";
            
            if (alertBox) {
                alertBox.style.display = "block";
                setTimeout(() => { alertBox.style.display = "none"; }, 5000);
            }
        } 
        // Fallback, falls doch nur ein normaler Text geschickt wird
        else if (typeof event.data === 'string') {
            var targetField = document.getElementById("prompt");
            if (targetField) { targetField.value = event.data; }
        }
    });

    // --- 2. HELPERS ---
    const $ = (id) => document.getElementById(id);
    let chatHistory = [];

    function toggleFullScreen() {
        const elem = $("animation-output");
        if(elem.requestFullscreen) elem.requestFullscreen();
        else if(elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
    }

    function renderHistory() {
        const out = $("textOut");
        out.innerHTML = "";
        
        chatHistory.forEach(turn => {
            const div = document.createElement("div");
            div.className = `chat-turn role-${turn.role}`;
            
            // WICHTIG: Sagt dem Browser, dass er die echten Zeilenumbr√ºche der KI im Text anzeigen soll!
            div.style.whiteSpace = "pre-wrap"; 
            
            let txt = turn.parts[0].text;
            
            // 1. HTML-Tags maskieren (damit der Code als Text und nicht als Webseite gerendert wird)
            txt = txt.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            // 2. Den riesigen Code-Block in ein einklappbares Men√º (<details>) verwandeln!
            txt = txt.replace(/```(?:html|javascript|css|js)?\s*([\s\S]*?)```/gi, 
                `<details style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px dashed var(--accent);">
                    <summary style="cursor: pointer; font-weight: bold; color: var(--accent); outline: none;">
                        üíª Generierter Simulations-Code (Klicken zum Einblenden)
                    </summary>
                    <pre style="margin-top: 15px; overflow-x: auto; white-space: pre; font-size: 11px;"><code>$1</code></pre>
                </details>`
            );
            
            // 3. Fettgedruckten Text (Markdown) formatieren
            txt = txt.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
            
            // 4. Sch√∂nere Rollen-Namen f√ºr das Chat-Fenster
            let roleName = turn.role === 'user' ? 'Du' : 'Tutor Newton üçè';
            
            div.innerHTML = `<div class="chat-role">${roleName}</div> ${txt}`;
            out.appendChild(div);
        });
        
        // Immer brav nach unten scrollen im Chat
        out.scrollTop = out.scrollHeight;
    }

    function extractCode(text) {
        if(!text) return null;
        const match = text.match(/```html\s*([\s\S]*?)\s*```/i);
        if(match) return match[1];
        if(text.includes("<html")) return text;
        return null;
    }

    // --- ZENTRALE SENDE-FUNKTION (Handles normal & debug) ---
    async function sendRequest(promptText, isDebug = false) {
        // API Key ist jetzt sicher im Cloudflare Worker gespeichert
          const model = "gemini-2.5-pro"; 
        //const model = "gemini-3.1-pro-preview"; 
      
        
        if(!promptText) { alert("Kein Text!"); return; }

        // --- GEHEIME SYSTEMANWEISUNGEN F√úR DIE KI ---
        const role = localStorage.getItem('physics_user_role') || 'student';
        let finalSystemInstruction = "";

        if (role === 'student') {
            // Wenn die Vorlage (z.B. Affenschuss) geheime Lernziele geschickt hat:
            if (currentSecretInstruction && currentSecretInstruction.trim() !== "") {
                 finalSystemInstruction = "Du bist ein geduldiger KI-Physik-Tutor f√ºr die 10. Klasse.\n" + currentSecretInstruction;
            } else {
                 // Standard-Regel f√ºr alle anderen, freien Sch√ºler-Experimente:
                 finalSystemInstruction = "Du bist ein geduldiger KI-Physik-Tutor f√ºr die 10. Klasse. Verrate niemals sofort die L√∂sung. Nutze den sokratischen Dialog (Leitfragen), um den Sch√ºler selbst auf die physikalischen Gesetzm√§√üigkeiten kommen zu lassen.";
            }
        } else {
            finalSystemInstruction = "Du bist ein hochprofessioneller KI-Labor-Assistent f√ºr Physiklehrkr√§fte. Das Themenspektrum ist offen. Erzeuge didaktisch wertvolle, hochpr√§zise Fachsimulationen.";
        }

        // UI States
        const btnSend = $("send");
        const btnDebug = $("debug-send");
        const stat = $("status");
        
        btnSend.disabled = true; btnSend.classList.add("loading");
        btnDebug.disabled = true; if(isDebug) btnDebug.classList.add("loading");
        
        $("reception-alert").style.display="none";
        stat.textContent = isDebug ? "Korrigiere Code..." : "Generiere Simulation...";

        // Nachricht zur History hinzuf√ºgen
        chatHistory.push({ role: "user", parts: [{ text: promptText }] });
        renderHistory();
        
        // Felder 
        if(!isDebug) $("prompt").value = ""; 
        else $("debug-input").value = "";

        try {
            // --- HIER WIRD DAS PAKET GEPACKT ---
            const requestBody = {
                system_instruction: {
                    parts: [{ text: finalSystemInstruction }] // Die KI bekommt heimlich ihre Befehle
                },
                contents: chatHistory // Der normale Chat-Verlauf
            };

            const response = await fetch(`https://physikapi.dinc-yavuz.workers.dev/?model=${model}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody) // Wir senden das komplette Paket!
            });

            const data = await response.json();
            
            if(!response.ok) throw new Error(data.error?.message || "Fehler");

            const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Keine Antwort";
            chatHistory.push({ role: "model", parts: [{ text: aiText }] });
            renderHistory();
            stat.textContent = "Fertig.";
            stat.className = "status ok";
            $("chat-hint").style.display = "block";
            $("prompt").placeholder = "Antworte Tutor Newton hier...";
            
            // Code verarbeiten & anzeigen
            const code = extractCode(aiText);
            if(code) {
                const container = $("animation-container");
                const frame = $("animation-output");
                const loader = $("anim-loader");

                container.style.display = "block";
                loader.style.display = "flex"; 

                frame.srcdoc = code;
                frame.onload = () => {
                    setTimeout(() => { loader.style.display = "none"; }, 800);
                };
                
                // Beim ersten Mal scrollen (nicht beim Debuggen, da ist man schon unten)
                if(!isDebug) container.scrollIntoView({ behavior: 'smooth' });
            }

        } catch(err) {
            stat.textContent = "Fehler: " + err.message;
            stat.className = "status err";
            chatHistory.pop(); // User Msg entfernen bei Fehler
        } finally {
            btnSend.disabled = false; btnSend.classList.remove("loading");
            btnDebug.disabled = false; btnDebug.classList.remove("loading");
        }
    }

    // --- BUTTON EVENT LISTENERS ---

    // 1. Initialer Send Button
    $("send").addEventListener("click", () => {
        sendRequest($("prompt").value.trim(), false);
    });

    // 2. Debug Send Button (NEU)
    $("debug-send").addEventListener("click", () => {
        const feedback = $("debug-input").value.trim();
        if(!feedback) return;
        
        // Wir bauen einen cleveren Prompt f√ºr die KI
        const debugPrompt = `Der vorherige Code hatte ein Problem oder es fehlt etwas: "${feedback}". 
        Bitte analysiere den Fehler im Kontext des bisherigen Codes. 
        Generiere die VOLLST√ÑNDIGE, korrigierte HTML-Datei neu (keine Teilst√ºcke), damit die Simulation funktioniert.`;
        
        sendRequest(debugPrompt, true);
    });

    // 3. Clear
    $("clear").addEventListener("click", () => {
        chatHistory=[]; 
        $("textOut").innerHTML="(noch nichts)"; 
        $("status").textContent="";
        $("reception-alert").style.display="none";
        $("animation-container").style.display="none";
    });

    // 4. Chat Copy (NEU)
    $("copyChat").addEventListener("click", () => {
        if (chatHistory.length === 0) {
            alert("Noch kein Chat-Verlauf vorhanden!");
            return;
        }

        // Text sch√∂n formatieren f√ºr das Protokoll
        let textLog = "--- CHAT PROTOKOLL START ---\n\n";
        chatHistory.forEach((entry, index) => {
            const role = entry.role === 'user' ? 'SCH√úLER/LEHRER' : 'KI (GEMINI)';
            textLog += `[#${index + 1} ${role}]:\n${entry.parts[0].text}\n\n------------------------------------------------\n\n`;
        });
        textLog += "--- CHAT PROTOKOLL ENDE ---";

        // In Zwischenablage kopieren
        navigator.clipboard.writeText(textLog).then(() => {
            const btn = $("copyChat");
            const originalText = btn.innerText;
            
            // Visuelles Feedback
            btn.innerText = "‚úÖ Kopiert!";
            btn.style.background = "rgba(103, 232, 166, 0.2)"; // Leicht gr√ºn
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = "";
            }, 2000);
        }).catch(err => {
            console.error(err);
            alert("Fehler beim Kopieren (Browser erlaubt es evtl. nicht).");
        });
    });
    
  </script>
</body>
</html>
